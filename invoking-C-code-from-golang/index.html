<!DOCTYPE html> <!-- Type on Strap jekyll theme v2.0.0 Copyright 2016-2019 Sylhare Theme free for personal and commercial use under the MIT license https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE --> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> <!-- CSS --> <link rel="stylesheet" href="/assets/css/main.css"> <!--Favicon--> <link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon"> <!-- Canonical --> <link rel="canonical" href="https://tech-lessons.in/invoking-C-code-from-golang/"> <!-- KaTeX 0.8.3 --> <!-- if you have any issue check https://github.com/KaTeX/KaTeX --> <!-- Google Analytics --> <!-- End Google Analytics --> <!-- seo tags --> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Invoking C Code from Golang | tech-lessons.in</title> <meta name="generator" content="Jekyll v4.2.1" /> <meta property="og:title" content="Invoking C Code from Golang" /> <meta name="author" content="Sarthak Makhija" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Let’s explore Golang’s C package to invoke C code from Golang by building a linked list in C which would offer put, get, getAllValues, length and close features." /> <meta property="og:description" content="Let’s explore Golang’s C package to invoke C code from Golang by building a linked list in C which would offer put, get, getAllValues, length and close features." /> <link rel="canonical" href="https://tech-lessons.in/invoking-C-code-from-golang/" /> <meta property="og:url" content="https://tech-lessons.in/invoking-C-code-from-golang/" /> <meta property="og:site_name" content="tech-lessons.in" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2021-12-21T00:00:00+05:30" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Invoking C Code from Golang" /> <script type="application/ld+json"> {"url":"https://tech-lessons.in/invoking-C-code-from-golang/","author":{"@type":"Person","name":"Sarthak Makhija"},"headline":"Invoking C Code from Golang","dateModified":"2021-12-21T00:00:00+05:30","datePublished":"2021-12-21T00:00:00+05:30","@type":"BlogPosting","description":"Let’s explore Golang’s C package to invoke C code from Golang by building a linked list in C which would offer put, get, getAllValues, length and close features.","mainEntityOfPage":{"@type":"WebPage","@id":"https://tech-lessons.in/invoking-C-code-from-golang/"},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <!-- Manual seo tags --> <!-- <title>Invoking C Code from Golang | tech-lessons.in</title> <meta name="description" content="Let's explore Golang's C package to invoke C code from Golang by building a linked list in C which would offer put, get, getAllValues, length and close featu..."> --> </head> <script defer=true src="/assets/js/main.min.js"></script> <body> <header class="site-header"> <!-- Toggle menu --> <nav class="clear"> <a aria-label="pull" id="pull" class="toggle" href="#"> <i class="fa fa-bars fa-lg"></i> </a> <!-- Brand Logo --> <a class="navbar-brand" href="/"> <img src="/assets/img/pexels/logo.png" alt="tech-lessons" title="tech-lessons"> </a> <!-- Menu --> <ul class="hide"> <li class="separator"> |</li> <li> <a class="clear" aria-label="Home" title="Home" href="/"> <i class="fa fa-fw fa-home" aria-hidden="true"></i> Home </a> </li> <li class="separator"> |</li> <li> <a class="clear" aria-label="Search" title="Search" href="/search/"> <i class="fa fa-fw fa-search" aria-hidden="true"></i> Search </a> </li> <li class="separator"> |</li> <li> <a class="clear" aria-label="Tags" title="Tags" href="/tags/"> <i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags </a> </li> <li class="separator"> |</li> <li> <a class="clear" aria-label="About Me" title="About Me" href="/about/"> <i class="fa fa-fw fa-male" aria-hidden="true"></i> About Me </a> </li> </ul> </nav> </header> <div class="content"> <meta property="og:url" content="/invoking-C-code-from-golang/" /> <meta property="og:type" content="article" /> <meta property="og:title" content="Invoking C Code from Golang" /> <meta property="og:description" content="Let&#39;s explore Golang&#39;s C package to invoke C code from Golang by building a linked list in C which would offer put, get, getAllValues, length and close features." /> <meta property="og:image" content="assets/img/pexels/invoking-C-code-from-golang.png" /> <article class="feature-image"> <header id="main" style=""></header> <section class="post-content"> <h1 id="Invoking+C+Code+from+Golang" class="title">Invoking C Code from Golang</h1> <p>The article attempts to explore Golang’s “C” package which allows invoking C code from Golang. Before we get into the idea of invoking C code from Golang, let’s see a use-case where this might be needed.</p> <h3 id="interfacing-with-an-existing-c-library">Interfacing with an existing C library</h3> <p>Let’s consider that we wish to develop a storage engine for pmem (persistent memory) in Golang. In order to develop this, we might want to use <a href="https://github.com/pmem/pmdk">pmdk - persistent memory development kit</a> which is written in C. This effectively means we want a way to bridge Golang and C code; invoke C code from Golang.</p> <h3 id="c-package-in-golang">“C” package in Golang</h3> <p>Go provides a package called “C” to interface with C code. Some features provided by this package include -</p> <ul> <li>standard C numeric types</li> <li>access to structs defined in C</li> <li>access to function like <code class="language-plaintext highlighter-rouge">malloc</code> and <code class="language-plaintext highlighter-rouge">free</code></li> </ul> <h3 id="c-code">C Code</h3> <p>Let’s start by creating a linked list in C which will be later invoked from Golang code. Let’s start with <code class="language-plaintext highlighter-rouge">linkedlist.h</code> file which defines a struct called <code class="language-plaintext highlighter-rouge">Node</code>, and a set of operations supported by linked list.</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">Node</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">Node</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">put</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">get</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">);</span></code></pre></figure> <p>Our <code class="language-plaintext highlighter-rouge">Node</code> struct has a key, and a value which are of type <code class="language-plaintext highlighter-rouge">integer</code> and a pointer to the next node. It also supports 2 behaviors <code class="language-plaintext highlighter-rouge">put</code> and <code class="language-plaintext highlighter-rouge">get</code>.</p> <p>Let’s add <code class="language-plaintext highlighter-rouge">linkedlist.c</code> and add <code class="language-plaintext highlighter-rouge">put</code> to begin with.</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include "linkedlist.h"
#include &lt;stdlib.h&gt;
</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="o">*</span><span class="n">current</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">put</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Node</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">Node</span><span class="p">));</span>
        <span class="n">head</span> <span class="o">-&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
        <span class="n">head</span> <span class="o">-&gt;</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">Node</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Node</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">Node</span><span class="p">));</span>
        <span class="n">next</span> <span class="o">-&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
        <span class="n">next</span> <span class="o">-&gt;</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="n">current</span> <span class="o">-&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><code class="language-plaintext highlighter-rouge">put</code> does the following -</p> <ul> <li>If head is NULL <ul> <li>Creates a <code class="language-plaintext highlighter-rouge">new node</code></li> <li>Points <code class="language-plaintext highlighter-rouge">head</code> to the <code class="language-plaintext highlighter-rouge">new node</code></li> <li>Assigns key and value to the <code class="language-plaintext highlighter-rouge">head</code></li> <li>Points <code class="language-plaintext highlighter-rouge">current</code> to the <code class="language-plaintext highlighter-rouge">head</code></li> </ul> </li> <li>Else <ul> <li>Creates a <code class="language-plaintext highlighter-rouge">new node</code></li> <li>Assigns key and value to the <code class="language-plaintext highlighter-rouge">new node</code></li> <li>Assigns <code class="language-plaintext highlighter-rouge">next</code> of the <code class="language-plaintext highlighter-rouge">current</code> node to the <code class="language-plaintext highlighter-rouge">new node</code></li> <li>Points <code class="language-plaintext highlighter-rouge">current</code> to the <code class="language-plaintext highlighter-rouge">new node</code></li> </ul> </li> </ul> <p>Let’s add <code class="language-plaintext highlighter-rouge">get</code> which will return a value by key.</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">get</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">Node</span><span class="o">*</span> <span class="n">node</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">!=</span> <span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">node</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure> <p><code class="language-plaintext highlighter-rouge">get</code> does the following -</p> <ul> <li>Makes a temporary variable <code class="language-plaintext highlighter-rouge">node</code> point to <code class="language-plaintext highlighter-rouge">head</code></li> <li>Iterates while <code class="language-plaintext highlighter-rouge">node</code> is not NULL and <code class="language-plaintext highlighter-rouge">key of the node</code> is not equal to the incoming <code class="language-plaintext highlighter-rouge">key</code></li> <li>If <code class="language-plaintext highlighter-rouge">node</code> is NULL, returns -1</li> <li>Else returns the value pointed by <code class="language-plaintext highlighter-rouge">node</code></li> </ul> <h3 id="time-to-invoke-c-code-from-golang">Time to invoke C code from Golang</h3> <p>Let’s create a file <code class="language-plaintext highlighter-rouge">linkedlist.go</code> which will provide <code class="language-plaintext highlighter-rouge">Put</code> and <code class="language-plaintext highlighter-rouge">GetBy</code> behaviors. These functions will internally invoke C functions.</p> <figure class="highlight"><pre><code class="language-golang" data-lang="golang"><span class="k">package</span> <span class="n">linkedlist</span>

<span class="c">// #cgo CFLAGS: -g -Wall</span>
<span class="c">// #include "linkedlist.h"</span>
<span class="k">import</span> <span class="s">"C"</span></code></pre></figure> <p>This is how the beginning of our go file looks like -</p> <ul> <li>Go package is <code class="language-plaintext highlighter-rouge">linkedlist</code></li> <li>Adding the line <code class="language-plaintext highlighter-rouge">#cgo CFLAGS: -g -Wall</code> compiles the C code with gcc options: (-g) which is used to enable debug symbols and (-Wall) which is used to enable all warnings</li> <li><code class="language-plaintext highlighter-rouge">linkedlist.h</code> is included for our linked list related functions</li> <li>The import “C” allows us to integrate with C code</li> <li>The comments above <code class="language-plaintext highlighter-rouge">import C</code> represent the actual C code that will be consumed by the rest of our golang code</li> </ul> <p>Let’s add <code class="language-plaintext highlighter-rouge">Put</code> in Golang.</p> <figure class="highlight"><pre><code class="language-golang" data-lang="golang"><span class="k">func</span> <span class="n">Put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">C</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="kt">int</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">C</span><span class="o">.</span><span class="kt">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<span class="p">}</span></code></pre></figure> <p>Golang <code class="language-plaintext highlighter-rouge">Put</code> does the following -</p> <ul> <li>Creates a C int by using <code class="language-plaintext highlighter-rouge">C.int</code> on key and value</li> <li>Invokes <code class="language-plaintext highlighter-rouge">put</code> by using <code class="language-plaintext highlighter-rouge">C.put</code>, passing C.int</li> </ul> <p>Let’s add <code class="language-plaintext highlighter-rouge">GetBy</code>.</p> <figure class="highlight"><pre><code class="language-golang" data-lang="golang"><span class="k">func</span> <span class="n">GetBy</span><span class="p">(</span><span class="n">key</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">int</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="kt">int</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
<span class="p">}</span></code></pre></figure> <p>Golang <code class="language-plaintext highlighter-rouge">GetBy</code> does the following -</p> <ul> <li>Creates a C int by using <code class="language-plaintext highlighter-rouge">C.int</code> on key</li> <li>Invokes <code class="language-plaintext highlighter-rouge">get</code> by using <code class="language-plaintext highlighter-rouge">C.get</code></li> <li>Convert the return value received from <code class="language-plaintext highlighter-rouge">C.get(C.int(key))</code> to <code class="language-plaintext highlighter-rouge">Golang's int</code></li> </ul> <p><em>Putting it all together</em> -</p> <figure class="highlight"><pre><code class="language-golang" data-lang="golang"><span class="k">package</span> <span class="n">linkedlist</span>

<span class="c">// #cgo CFLAGS: -g -Wall</span>
<span class="c">// #include "linkedlist.h"</span>
<span class="k">import</span> <span class="s">"C"</span>

<span class="k">func</span> <span class="n">Put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">C</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="kt">int</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">C</span><span class="o">.</span><span class="kt">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">GetBy</span><span class="p">(</span><span class="n">key</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">int</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="kt">int</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
<span class="p">}</span></code></pre></figure> <p>Let’s add a Golang test to see if this integration works or not.</p> <figure class="highlight"><pre><code class="language-golang" data-lang="golang"><span class="k">package</span> <span class="n">linkedlist_test</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"reflect"</span>
	<span class="s">"testing"</span>
<span class="p">)</span>
<span class="k">import</span> <span class="s">"linkedlist"</span>

<span class="k">func</span> <span class="n">TestPutsASingleKeyValue</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">linkedlist</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
    
    <span class="n">value</span> <span class="o">:=</span> <span class="n">linkedlist</span><span class="o">.</span><span class="n">GetBy</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="m">100</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Expected %v, received %v"</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>Let’s Run the test using <code class="language-plaintext highlighter-rouge">go test</code>, and it should work.</p> <h3 id="freeing-the-linked-list">Freeing the linked list</h3> <p>We would like to add another test which adds multiple key value pairs and gets a value by key. Before we do that, we would like to start with a fresh linked list for each test. In order to do that let’s add a behavior <code class="language-plaintext highlighter-rouge">close</code> in C linked list which frees all the nodes in the linked list.</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">close</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">Node</span><span class="o">*</span> <span class="n">node</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">node</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
      <span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
      <span class="n">free</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><code class="language-plaintext highlighter-rouge">close</code> does the following -</p> <ul> <li>Makes a temporary variable <code class="language-plaintext highlighter-rouge">node</code></li> <li>Iterates while <code class="language-plaintext highlighter-rouge">head</code> is not NULL</li> <li>Makes <code class="language-plaintext highlighter-rouge">node</code> point to head and moves <code class="language-plaintext highlighter-rouge">head</code> ahead</li> <li>Frees the memory pointed to by <code class="language-plaintext highlighter-rouge">node</code></li> </ul> <p>Let’s invoke <code class="language-plaintext highlighter-rouge">C's close</code> from Golang</p> <figure class="highlight"><pre><code class="language-golang" data-lang="golang"><span class="k">func</span> <span class="n">Close</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">C</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
<span class="p">}</span></code></pre></figure> <p>Let’s edit the existing test case and add a new one.</p> <figure class="highlight"><pre><code class="language-golang" data-lang="golang"><span class="k">func</span> <span class="n">TestPutsASingleKeyValue</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="n">linkedlist</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="n">linkedlist</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>

    <span class="n">value</span> <span class="o">:=</span> <span class="n">linkedlist</span><span class="o">.</span><span class="n">GetBy</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="m">100</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Expected %v, received %v"</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestPutsMultipleKeyValues</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="n">linkedlist</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="n">linkedlist</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
    <span class="n">linkedlist</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="m">20</span><span class="p">,</span> <span class="m">200</span><span class="p">)</span>
    <span class="n">linkedlist</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="m">30</span><span class="p">,</span> <span class="m">300</span><span class="p">)</span>

    <span class="n">value</span> <span class="o">:=</span> <span class="n">linkedlist</span><span class="o">.</span><span class="n">GetBy</span><span class="p">(</span><span class="m">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="m">200</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Expected %v, received %v"</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>As a part of these tests, we are now closing the linked list by invoking <code class="language-plaintext highlighter-rouge">defer linkedlist.Close()</code> which will internally free all the nodes.</p> <h3 id="lets-get-all-the-values">Let’s get all the values</h3> <p>We would like to return all the values from linked list. As a first step, we would like to return a pointer to an integer from C code to Golang. Let’s code <code class="language-plaintext highlighter-rouge">getAllValues</code> in C.</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span><span class="o">*</span> <span class="nf">getAllValues</span><span class="p">()</span> <span class="p">{</span>
     <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="p">();</span>
     <span class="kt">int</span><span class="o">*</span> <span class="n">values</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
     <span class="k">struct</span> <span class="n">Node</span><span class="o">*</span> <span class="n">node</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
     <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

     <span class="k">while</span> <span class="p">(</span><span class="n">node</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="n">value</span><span class="p">;</span>
         <span class="n">node</span> <span class="o">=</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="n">next</span><span class="p">;</span>
         <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="n">values</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure> <p><code class="language-plaintext highlighter-rouge">getAllValues</code> does the following -</p> <ul> <li>Invokes <code class="language-plaintext highlighter-rouge">length</code> to get the total number of nodes in the linked list</li> <li>Allocates memory to hold <code class="language-plaintext highlighter-rouge">len</code> integer values in a variable called <code class="language-plaintext highlighter-rouge">values</code></li> <li>Creates a pointer called <code class="language-plaintext highlighter-rouge">node</code> to point to <code class="language-plaintext highlighter-rouge">head</code></li> <li>Iterates while <code class="language-plaintext highlighter-rouge">node</code> is not NULL</li> <li>Collects the value pointed to by <code class="language-plaintext highlighter-rouge">node</code> in <code class="language-plaintext highlighter-rouge">values</code></li> <li>Returns <code class="language-plaintext highlighter-rouge">values</code> which is a pointer to an integer</li> </ul> <p>Let’s also add <code class="language-plaintext highlighter-rouge">length</code> function -</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">length</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">Node</span><span class="o">*</span> <span class="n">node</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">node</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="n">next</span><span class="p">;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure> <p><code class="language-plaintext highlighter-rouge">length</code> does the following -</p> <ul> <li>Creates a pointer called <code class="language-plaintext highlighter-rouge">node</code> to point to <code class="language-plaintext highlighter-rouge">head</code></li> <li>Iterates while <code class="language-plaintext highlighter-rouge">node</code> is not NULL</li> <li>Increments count for each node</li> <li>Returns count</li> </ul> <p>Time to invoke <code class="language-plaintext highlighter-rouge">getAllValues</code> from Golang.</p> <figure class="highlight"><pre><code class="language-golang" data-lang="golang"><span class="k">func</span> <span class="n">GetsAllValues</span><span class="p">()</span> <span class="p">[]</span><span class="kt">int</span> <span class="p">{</span>
	<span class="n">length</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">length</span><span class="p">())</span>
	<span class="n">intPointer</span> <span class="o">:=</span> <span class="n">C</span><span class="o">.</span><span class="n">getAllValues</span><span class="p">()</span>
	<span class="k">defer</span> <span class="n">C</span><span class="o">.</span><span class="n">free</span><span class="p">(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">intPointer</span><span class="p">))</span>

	<span class="n">slice</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="m">1</span> <span class="o">&lt;&lt;</span> <span class="m">28</span><span class="p">]</span><span class="n">C</span><span class="o">.</span><span class="kt">int</span><span class="p">)(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">intPointer</span><span class="p">))[</span><span class="o">:</span><span class="n">length</span><span class="o">:</span><span class="n">length</span><span class="p">]</span>

	<span class="k">var</span> <span class="n">values</span> <span class="p">[]</span><span class="kt">int</span>
	<span class="k">for</span> <span class="n">index</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">values</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="kt">int</span><span class="p">(</span><span class="n">slice</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">values</span>
<span class="p">}</span></code></pre></figure> <p><code class="language-plaintext highlighter-rouge">GetAllValues</code> does the following -</p> <ul> <li>Invokes <code class="language-plaintext highlighter-rouge">C.length</code> to get the total number of linked list nodes</li> <li>Invokes <code class="language-plaintext highlighter-rouge">C.getAllValues()</code> to get a pointer to an integer</li> <li>We would like to free the memory held by the pointer returned from <code class="language-plaintext highlighter-rouge">C.getAllValues()</code>. In order to do that, we need to invoke <code class="language-plaintext highlighter-rouge">C.free</code> and we use <code class="language-plaintext highlighter-rouge">unsafe.Pointer</code> which allows creating a pointer to any arbitrary type</li> <li>In order to be able to invoke <code class="language-plaintext highlighter-rouge">C.free</code> or <code class="language-plaintext highlighter-rouge">C.malloc</code>, we need to import <code class="language-plaintext highlighter-rouge">stdlib.h</code> in Golang code</li> <li>So far we have a pointer or let’s say a C pointer. We need a way to convert that to Go slice.</li> </ul> <p>The expression <code class="language-plaintext highlighter-rouge">slice := (*[1 &lt;&lt; 28]C.int)(unsafe.Pointer(intPointer))[:length:length]</code> is made up of 3 parts -</p> <figure class="highlight"><pre><code class="language-golang" data-lang="golang"><span class="m">1.</span> <span class="n">unsafePointer</span> <span class="o">:=</span> <span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">intPointer</span><span class="p">)</span> <span class="n">creates</span> <span class="n">an</span> <span class="n">unsafe</span> <span class="n">pointer</span>

<span class="m">2.</span> <span class="s">`https://stackoverflow.com/questions/48756732/what-does-1-30c-yourtype-do-exactly-in-cgo`</span> 
   <span class="n">arrayPtr</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="m">1</span> <span class="o">&lt;&lt;</span> <span class="m">28</span><span class="p">]</span><span class="n">C</span><span class="o">.</span><span class="kt">int</span><span class="p">)(</span><span class="n">unsafePointer</span><span class="p">)</span><span class="o">.</span><span class="s">`*[1 &lt;&lt; 28]C.YourType`</span> <span class="n">doesn</span><span class="err">'</span><span class="n">t</span> <span class="n">do</span> <span class="n">anything</span> <span class="n">itself</span><span class="p">,</span> <span class="n">it</span> <span class="n">is</span> <span class="n">a</span> <span class="k">type</span><span class="o">.</span> 
   <span class="n">Specifically</span><span class="p">,</span> <span class="n">it</span> <span class="n">is</span> <span class="n">a</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">an</span> <span class="n">array</span> <span class="n">of</span> <span class="n">size</span> <span class="m">1</span> <span class="o">&lt;&lt;</span> <span class="m">28</span><span class="p">,</span> <span class="n">of</span> <span class="n">C</span><span class="o">.</span><span class="n">YourType</span> <span class="n">values</span><span class="o">.</span> 
   <span class="n">Statement</span> <span class="m">2</span><span class="p">)</span> <span class="n">converts</span> <span class="n">unsafePointer</span> <span class="n">to</span> <span class="n">a</span> <span class="n">pointer</span> <span class="n">of</span> <span class="n">the</span> <span class="k">type</span> <span class="o">*</span><span class="p">[</span><span class="m">1</span> <span class="o">&lt;&lt;</span> <span class="m">28</span><span class="p">]</span><span class="n">C</span><span class="o">.</span><span class="kt">int</span>

<span class="m">3.</span> <span class="n">slice</span> <span class="o">:=</span> <span class="n">arrayPtr</span><span class="p">[</span><span class="o">:</span><span class="n">length</span><span class="o">:</span><span class="n">length</span><span class="p">],</span> <span class="n">slices</span> <span class="n">the</span> <span class="n">array</span> <span class="n">into</span> <span class="n">a</span> <span class="n">Go</span> <span class="n">slice</span></code></pre></figure> <ul> <li>We now have a Golang slice of type <code class="language-plaintext highlighter-rouge">C.int</code> but we need to return a Golang slice of <code class="language-plaintext highlighter-rouge">Go int</code>. So we iterate through the <code class="language-plaintext highlighter-rouge">slice</code>, convert <code class="language-plaintext highlighter-rouge">C.int</code> to <code class="language-plaintext highlighter-rouge">Golang int</code>, collect <code class="language-plaintext highlighter-rouge">values</code> and return it</li> </ul> <p>Let’s quickly add a golang test for <code class="language-plaintext highlighter-rouge">GetAllValues</code>.</p> <figure class="highlight"><pre><code class="language-golang" data-lang="golang"><span class="k">func</span> <span class="n">TestGetAllValues</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="n">linkedlist</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="n">linkedlist</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
    <span class="n">linkedlist</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="m">20</span><span class="p">,</span> <span class="m">200</span><span class="p">)</span>
    <span class="n">linkedlist</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="m">30</span><span class="p">,</span> <span class="m">300</span><span class="p">)</span>

    <span class="n">values</span> <span class="o">:=</span> <span class="n">linkedlist</span><span class="o">.</span><span class="n">GetAllValues</span><span class="p">()</span>
    <span class="n">expected</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="m">100</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="m">300</span><span class="p">}</span>
    
    <span class="k">if</span> <span class="o">!</span><span class="n">reflect</span><span class="o">.</span><span class="n">DeepEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Expected %v, received %v"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>That is it, run the test and get all the values from linked list.</p> <h3 id="code">Code</h3> <p>The code for this article is available <a href="https://github.com/SarthakMakhija/CGO-learning">here</a></p> <h3 id="references">References</h3> <ul> <li><a href="https://karthikkaranth.me/blog/calling-c-code-from-go/">Calling C code from go</a></li> <li><a href="https://stackoverflow.com/questions/64852226/how-to-iterate-through-a-c-array">Golang slices and C pointers</a></li> <li><a href="https://stackoverflow.com/questions/48756732/what-does-1-30c-yourtype-do-exactly-in-cgo">What does 1-30c-yourtype do exactly in cgo</a></li> <li><a href="https://github.com/golang/go/issues/31409">ld: symbol(s) not found for architecture x86_64</a></li> </ul> </section> <!-- Social media shares --> <div class="share-buttons"> <ul class="share-buttons"> <div class="meta">Share</div> <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ftech-lessons.in%2Finvoking-C-code-from-golang%2F" target="_blank" title=" Facebook"> <i class="fa fa-facebook-square fa-2x" aria-hidden="true"></i> <span class="sr-only">Share on Facebook</span> </a> </li> <li> <a href="https://twitter.com/intent/tweet?text=Invoking+C+Code+from+Golang%20https%3A%2F%2Ftech-lessons.in%2Finvoking-C-code-from-golang%2F" target="_blank" title=""> <i class="fa fa-twitter-square fa-2x" aria-hidden="true"></i> <span class="sr-only">Tweet</span> </a> </li> <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https://tech-lessons.in/invoking-C-code-from-golang/&title=Invoking+C+Code+from+Golang%20%7C%20tech-lessons.in&summary=&source=https://tech-lessons.in/invoking-C-code-from-golang/" target="_blank" title=" LinkedIn"> <i class="fa fa-linkedin fa-2x" aria-hidden="true"></i> <span class="sr-only">Share on LinkedIn</span> </a> </li> </ul> </div> <!-- Tag list --> <footer> <div class="tag-list"> <div class="meta">Tags</div> <a class="button" href="/tags#C"> <p><i class="fa fa-tag fa-fw"></i> C</p> </a> <a class="button" href="/tags#CGO"> <p><i class="fa fa-tag fa-fw"></i> CGO</p> </a> <a class="button" href="/tags#Golang"> <p><i class="fa fa-tag fa-fw"></i> Golang</p> </a> </div> </footer> </article> <!-- Disqus --> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'techlessons'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view comments.</noscript> </div> <!-- Post navigation --> <div id="post-nav"> <div id="next-post"> <a alt="Code without automated tests? Are we serious?" href="/code-without-automated-tests/"> <p>Next post</p> Code without automated tests? Are we serious? </a> </div> </div> <!-- To change color of links in the page --> <style> header#main { background-repeat:no-repeat; background-image: url('/assets/img/pexels/invoking-C-code-from-golang.png'); } </style> </div> <footer class="site-footer"> <p class="text"> tech-lessons.in © 2020. All Rights Reserved. Powered by <a href='https://jekyllrb.com/'>Jekyll</a> </p> <div class="footer-icons"> <ul> <li> <a href="https://github.com/sarthakmakhija" title="Follow on GitHub"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </li> <li> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" title="Follow on LinkedIn"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </li> </ul> <ul> </ul> </div> </footer> </body> </html>
