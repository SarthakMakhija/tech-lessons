<!DOCTYPE html> <!-- Type on Strap jekyll theme v2.0.0 Copyright 2016-2019 Sylhare Theme free for personal and commercial use under the MIT license https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE --> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> <!-- CSS --> <link rel="stylesheet" href="/assets/css/main.css"> <!--Favicon--> <link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon"> <!-- Canonical --> <link rel="canonical" href="https://tech-lessons.in/testing-serverless-journey/"> <!-- KaTeX 0.8.3 --> <!-- if you have any issue check https://github.com/KaTeX/KaTeX --> <!-- Google Analytics --> <!-- End Google Analytics --> <!-- seo tags --> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Testing Serverless Journey | tech-lessons.in</title> <meta name="generator" content="Jekyll v3.8.5" /> <meta property="og:title" content="Testing Serverless Journey" /> <meta name="author" content="Sarthak Makhija" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="It is time to test our Serverless journey which started with a web application that involved AWS lambda, AWS API Gateway and AWS DynamoDB. By the end of this article we should be confident that our application works as it is supposed to. Let’s introduce LocalStack." /> <meta property="og:description" content="It is time to test our Serverless journey which started with a web application that involved AWS lambda, AWS API Gateway and AWS DynamoDB. By the end of this article we should be confident that our application works as it is supposed to. Let’s introduce LocalStack." /> <link rel="canonical" href="https://tech-lessons.in/testing-serverless-journey/" /> <meta property="og:url" content="https://tech-lessons.in/testing-serverless-journey/" /> <meta property="og:site_name" content="tech-lessons.in" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-03-14T00:00:00+05:30" /> <script type="application/ld+json"> {"description":"It is time to test our Serverless journey which started with a web application that involved AWS lambda, AWS API Gateway and AWS DynamoDB. By the end of this article we should be confident that our application works as it is supposed to. Let’s introduce LocalStack.","author":{"@type":"Person","name":"Sarthak Makhija"},"@type":"BlogPosting","url":"https://tech-lessons.in/testing-serverless-journey/","headline":"Testing Serverless Journey","dateModified":"2020-03-14T00:00:00+05:30","datePublished":"2020-03-14T00:00:00+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://tech-lessons.in/testing-serverless-journey/"},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <!-- Manual seo tags --> <!-- <title>Testing Serverless Journey | tech-lessons.in</title> <meta name="description" content="It is time to test our Serverless journey which started with a web application that involved AWS lambda, AWS API Gateway and AWS DynamoDB. By the end of this..."> --> </head> <script defer=true src="/assets/js/main.min.js"></script> <body> <header class="site-header"> <!-- Toggle menu --> <nav class="clear"> <a aria-label="pull" id="pull" class="toggle" href="#"> <i class="fa fa-bars fa-lg"></i> </a> <!-- Brand Logo --> <a class="navbar-brand" href="/"> <img src="/assets/img/pexels/logo.png" alt="tech-lessons" title="tech-lessons"> </a> <!-- Menu --> <ul class="hide"> <li class="separator"> |</li> <li> <a class="clear" aria-label="Home" title="Home" href="/"> <i class="fa fa-fw fa-home" aria-hidden="true"></i> Home </a> </li> <li class="separator"> |</li> <li> <a class="clear" aria-label="About Me" title="About Me" href="/about/"> <i class="fa fa-fw fa-male" aria-hidden="true"></i> About Me </a> </li> <li class="separator"> |</li> <li> <a class="clear" aria-label="Search" title="Search" href="/search/"> <i class="fa fa-fw fa-search" aria-hidden="true"></i> Search </a> </li> <li class="separator"> |</li> <li> <a class="clear" aria-label="Tags" title="Tags" href="/tags/"> <i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags </a> </li> </ul> </nav> </header> <div class="content"> <meta property="og:url" content="/testing-serverless-journey/" /> <meta property="og:type" content="article" /> <meta property="og:title" content="Testing Serverless Journey" /> <meta property="og:description" content="It is time to test our Serverless journey which started with a web application that involved AWS lambda, AWS API Gateway and AWS DynamoDB. By the end of this article we should be confident that our application works as it is supposed to. Let&#39;s int..." /> <meta property="og:image" content="assets/img/pexels/testing-serverless.png" /> <article class="feature-image"> <header id="main" style=""></header> <section class="post-content"> <h1 id="Testing+Serverless+Journey" class="title">Testing Serverless Journey</h1> <p><!-- wp:paragraph --></p> <p>It is time to test our <a href="/beginning-serverless-journey">Serverless journey</a> which started with a web application that involved AWS lambda, AWS API Gateway and AWS DynamoDB. </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>We had some unit tests for our controller, service and request objects. But, these tests don't give us the kind of confidence we need to deploy our application. At this stage we don't even know if the query that is written in repository is going to work properly or not, forget about releasing the application.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>What we need is an ability to test the following - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>Repository works as expected by connecting to DynamoDB</li> <li>Lambda handler is able to receive an event from API Gateway and get an order by its id</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>In simple terms we need some form of integration testing. </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Let's welcome LocalStack</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>LocalStack<a href="https://github.com/localstack/localstack"> </a>is a fully functional local AWS cloud stack. Its <a href="https://github.com/localstack/localstack">github</a> page states the following - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:quote --></p> <blockquote class="wp-block-quote"><p><em>LocalStack</em>&nbsp;provides an easy-to-use test/mocking framework for developing Cloud applications. Currently, the focus is primarily on supporting the AWS cloud stack. </p> </blockquote> <p><!-- /wp:quote --></p> <p><!-- wp:paragraph --></p> <p>LocalStack spins up various Cloud APIs on local machine including S3, Lambda, DynamoDB and API Gateway. This is all we need to test our complete application. </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Some of you might be having a question "Why is S3 needed?". Well, we will get an answer to this by the end of this article. So, please hold on.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Understanding LocalStack</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>LocalStack can be made to run as a docker container on a host machine. It supports quite a number of AWS services which will run inside the docker container with different ports exposed on host machine. </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Before moving on let's look at this conversation to understand how can LocalStack be leveraged for testing Serverless application. </p> <figure class="wp-block-embed-youtube aligncenter wp-block-embed is-type-video is-provider-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"> <div class="wp-block-embed__wrapper"> <iframe width="800" height="400" src="https://www.youtube.com/embed/Xed6C8vskUo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe> </div> </figure> <p><!-- /wp:core-embed/youtube --></p> <p><!-- wp:paragraph --></p> <p>Let's take some small steps to test our application using LocalStack.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Writing Repository Test</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>In order to test repository layer we need to -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list {"ordered":true} --></p> <ol> <li>Build the project</li> <li>Have a docker container with a running DynamoDB service</li> <li>Facilitate creation of "orders" table in DynamoDB service</li> <li>Change the application to connect to local DynamoDB service</li> <li>Add integration tests for repository</li> </ol> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>Let's handle each of them one by one.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p><strong>Step 1: Build the project</strong></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Let's add a build task to our outer package.json which will execute <code>tsc</code>. Let's also add a types definition for node by executing <code>npm i @types/node</code>. Here, is how our build script looks like - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jest test/**"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"build"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tsc"</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Before we execute our build command, let's <code>exclude infra and test</code> folders from our outer tsconfig.json.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:preformatted --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="p">{</span>
  <span class="dl">"</span><span class="s2">compilerOptions</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">noEmitOnError</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">moduleResolution</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">node</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">module</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">commonjs</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">target</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">es6</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">outDir</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">inlineSourceMap</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">exclude</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">infra</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">]</span>
<span class="p">}</span></code></pre></figure> <p><!-- /wp:preformatted --></p> <p><!-- wp:paragraph --></p> <p>Now, we can execute <code>npm run build</code> which should produce a <code>dist</code> folder with compiled code.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p><em>Note we are using tsc to transpile our typescript code to javascript. We do not have any external dependencies to be packed with our distribution, had there been any we would have gone ahead with webpack.</em></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p><strong>Step 2: Docker container with a running DynamoDB service</strong></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Let's create a <i>docker-compose.yml</i> file referring to LocalStack image and <i>start the container as a pretest step in our package.json</i>.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2.1"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">localstack</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">localstack/localstack:0.10.7</span> <span class="c1">## use localstack image</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">4567-4599:4567-4599"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">${PORT_WEB_UI-8080}:${PORT_WEB_UI-8080}"</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">SERVICES=${SERVICES- }</span>
      <span class="pi">-</span> <span class="s">DEBUG=1</span>
      <span class="pi">-</span> <span class="s">DATA_DIR=${DATA_DIR- }</span>
      <span class="pi">-</span> <span class="s">PORT_WEB_UI=${PORT_WEB_UI- }</span>
      <span class="pi">-</span> <span class="s">LAMBDA_EXECUTOR=${LAMBDA_EXECUTOR- }</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">/var/run/docker.sock:/var/run/docker.sock"</span></code></pre></figure> <figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="w"> </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"pretest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"docker-compose -f test/docker-compose.yml up -d"</span><span class="p">,</span><span class="w"> </span><span class="err">//start</span><span class="w"> </span><span class="err">docker</span><span class="w"> </span><span class="err">compose</span><span class="w"> </span><span class="err">before</span><span class="w"> </span><span class="err">running</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">tests</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jest test/**"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"build"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tsc"</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Run the pretest command and see LocalStack running as docker container.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p><strong>Step 3: Facilitate creation of "orders" table in DynamoDB service</strong></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>With LocalStack container up and running, "orders" table needs to be created in DynamoDB service. In order to do this we will use CloudFormation template. So, let's write one -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">AWSTemplateFormatVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2010-09-09"</span>
<span class="na">Resources</span><span class="pi">:</span>
  <span class="na">OrdersTable</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::DynamoDB::Table</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">TableName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orders"</span> <span class="c1">## create "orders" table</span>
      <span class="na">AttributeDefinitions</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">AttributeName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orderId"</span>
          <span class="na">AttributeType</span><span class="pi">:</span> <span class="s2">"</span><span class="s">S"</span> <span class="c1">## use STRING as the data type for "orderId"</span>
      <span class="na">KeySchema</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">AttributeName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orderId"</span> <span class="c1">## use "orderId" as the HASH key</span>
          <span class="na">KeyType</span><span class="pi">:</span> <span class="s2">"</span><span class="s">HASH"</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>We will also create a script to deploy CloudFormation template against LocalStack. This script will also be executed as a part of our pretest step.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#!/bin/sh</span>

aws cloudformation deploy <span class="se">\</span>
<span class="nt">--template-file</span> template.yaml <span class="se">\</span>
<span class="nt">--stack-name</span> order-service-stack <span class="se">\</span>
<span class="nt">--region</span> us-east-1 <span class="se">\</span>
<span class="nt">--capabilities</span> CAPABILITY_IAM  <span class="se">\</span>
<span class="nt">--endpoint-url</span> http://localhost:4581

<span class="nb">echo</span> <span class="s1">'aws cloudformation deploy executed against localstack'</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Few Quick Observations - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>As a part of "<code>aws cloudformation deploy</code>", us-east-1 has been specified as the region. By default, LocalStack runs with us-east-1 and we are using the same region</li> <li>As a part of "<code>aws cloudformation deploy</code>", we use 4581 as the port for local CloudFormation service which is exposed by LocalStack </li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>Let's update our package.json.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="w"> </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"localstack:up"</span><span class="p">:</span><span class="w"> </span><span class="s2">"docker-compose -f test/docker-compose.yml up -d"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"delay"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sleep 20"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"localstack:create-infra"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cd test/infra &amp;&amp; ./deploy.sh"</span><span class="p">,</span><span class="w">
    </span><span class="err">//start</span><span class="w"> </span><span class="err">docker</span><span class="w"> </span><span class="err">compose</span><span class="p">,</span><span class="w"> </span><span class="err">introduce</span><span class="w"> </span><span class="err">some</span><span class="w"> </span><span class="err">delay</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">run</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">above</span><span class="w"> </span><span class="err">script</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">part</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">pretest</span><span class="w">
    </span><span class="nl">"pretest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"npm run localstack:up &amp;&amp; npm run delay &amp;&amp; npm run localstack:create-infra"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jest test/**"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"build"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tsc"</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Following events happens as a part of pretest step -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>LocalStack docker container starts</li> <li>Some delay gets introduced to allow localstack services to be available</li> <li>CloudFormation template gets deployed against LocalStack by running deploy.sh</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>Before CloudFormation template can be deployed on LocalStack, a small delay has been specified to ensure LocalStack with its services is up and running.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p><strong>How do I know if "orders" table was created?</strong></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>LocalStack <em>tries</em> to replicate AWS services on local. By this theory, we should be able to run AWS commands by specifying the endpoint-url of the corresponding service.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"> <span class="o">&gt;</span> aws dynamodb scan <span class="nt">--table-name</span> orders <span class="nt">--endpoint-url</span> http://localhost:4569

//Output
<span class="o">{</span>
    <span class="s2">"Count"</span>: 0,
    <span class="s2">"Items"</span>: <span class="o">[]</span>,
    <span class="s2">"ScannedCount"</span>: 0,
    <span class="s2">"ConsumedCapacity"</span>: null
<span class="o">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Now, the last step is making a change in the application to connect to local DynamoDB.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p><strong>Step 4: Connecting the application to local DynamoDB service</strong></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Let's change the repository layer to connect to local DynamoDB service.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">GetItemInput</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">aws-sdk/clients/dynamodb</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Order</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../model/Order</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">dynamoDbClient</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../DynamoDbConfiguration</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">dynamoDb</span> <span class="o">=</span> <span class="nx">dynamoDbClient</span><span class="p">();</span> <span class="c1">//get dynamoDbClient from DynamoDbConfiguration</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrderRepository</span> <span class="p">{</span>

    <span class="k">async</span> <span class="nx">findAnOrderBy</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">getItemInputOptions</span><span class="p">:</span> <span class="nx">GetItemInput</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">TableName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">orders</span><span class="dl">"</span><span class="p">,</span> <span class="c1">//table name</span>
            <span class="na">Key</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">orderId</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span><span class="na">S</span><span class="p">:</span> <span class="nx">id</span><span class="p">}</span> <span class="c1">//query against orderId attribute of order item</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">dynamoDb</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">getItemInputOptions</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span> <span class="c1">//get a dynamo item by passing its id</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">Item</span> <span class="p">?</span> <span class="nx">Order</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">Item</span><span class="p">)</span> <span class="p">:</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">//map dynamo item to Order</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>DynamoDbConfiguration looks like - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">DynamoDB</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">aws-sdk</span><span class="dl">"</span>

<span class="kd">const</span> <span class="nx">executionEnvironment</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">defaultExecutionEnvironment</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">;</span>
    <span class="c1">//accept ExecutionEnvironment as the lambda environment variable</span>
    <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ExecutionEnvironment</span> <span class="o">||</span> <span class="nx">defaultExecutionEnvironment</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">isTestExecutionEnvironment</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">executionEnvironment</span><span class="p">()</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">dynamoDbClient</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isTestExecutionEnvironment</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">//return an instance of DynamoDB connecting to local dynamo endpoint exposed by localstack, if the execution environment is "test"</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">DynamoDB</span><span class="p">({</span>
            <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-east-1</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">endpoint</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">http://localhost:4569</span><span class="dl">"</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//return an instance of DynamoDB connecting to the actual region in AWS</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">DynamoDB</span><span class="p">({</span>
            <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ap-south-1</span><span class="dl">"</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Few Quick Observations - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>OrderRepository uses <code>dynamoDbClient</code> exposed by DynamoDbConfiguration <code>globally</code>. The reason being "aws-sdk" needs to be initialised during cold startup of lambda function</li> <li>DynamoDbConfiguration uses a lambda environment variable to determine if the execution environment is "test". By default, execution environment is considered as "test"</li> <li>If execution environment is "test", then an instance of DynamoDB connecting to local dynamo service is returned</li> <li>This also means <code>ExecutionEnvironment</code> needs to be passed during deployment as lambda environment variable</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p><strong>Step 5: Adding Integration Tests for Repository</strong></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">DeleteItemInput</span><span class="p">,</span> <span class="nx">PutItemInput</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">aws-sdk/clients/dynamodb</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">OrderRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/repository/OrderRepository</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Order</span><span class="p">}</span>           <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/model/Order</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">dynamoDbClient</span><span class="p">}</span>  <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/DynamoDbConfiguration</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">dynamoDb</span> <span class="o">=</span> <span class="nx">dynamoDbClient</span><span class="p">();</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">should return an order given there is AN order for the provided order id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">orderId</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">order-100</span><span class="dl">"</span><span class="p">;</span>
    
    <span class="k">await</span> <span class="nx">OrderRepositoryFixture</span><span class="p">.</span><span class="nx">deleteAnOrder</span><span class="p">(</span><span class="nx">orderId</span><span class="p">);</span> <span class="c1">//delete an existing order</span>
    <span class="k">await</span> <span class="nx">OrderRepositoryFixture</span><span class="p">.</span><span class="nx">createAn</span><span class="p">(</span><span class="k">new</span> <span class="nx">Order</span><span class="p">(</span><span class="nx">orderId</span><span class="p">,</span> <span class="mi">5000</span><span class="p">));</span> <span class="c1">//save an order in dynamo table</span>
    
    <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="k">new</span> <span class="nx">OrderRepository</span><span class="p">().</span><span class="nx">findAnOrderBy</span><span class="p">(</span><span class="nx">orderId</span><span class="p">);</span> <span class="c1">//find an order by orderId</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">orderId</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">orderId</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">amount</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">should NOT return an order given there is NO order for the provided order id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">orderId</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">no-order-present-for-this-order-id</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="k">new</span> <span class="nx">OrderRepository</span><span class="p">().</span><span class="nx">findAnOrderBy</span><span class="p">(</span><span class="nx">orderId</span><span class="p">);</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">order</span><span class="p">).</span><span class="nx">toBeNull</span><span class="p">();</span>
<span class="p">});</span>

<span class="kd">class</span> <span class="nx">OrderRepositoryFixture</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">async</span> <span class="nx">createAn</span><span class="p">(</span><span class="na">order</span><span class="p">:</span> <span class="nx">Order</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="na">item</span><span class="p">:</span> <span class="nx">PutItemInput</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">TableName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">orders</span><span class="dl">"</span><span class="p">,</span> <span class="c1">//table name</span>
            <span class="na">Item</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">orderId</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">S</span><span class="p">:</span> <span class="nx">order</span><span class="p">.</span><span class="nx">orderId</span> <span class="c1">//STRING orderId</span>
                <span class="p">},</span>
                <span class="dl">"</span><span class="s2">amount</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">N</span><span class="p">:</span> <span class="nx">order</span><span class="p">.</span><span class="nx">amount</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="c1">//NUMERIC amount</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">await</span> <span class="nx">dynamoDb</span><span class="p">.</span><span class="nx">putItem</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span> <span class="c1">//save the order</span>
    <span class="p">}</span>
    <span class="kd">static</span> <span class="k">async</span> <span class="nx">deleteAnOrder</span><span class="p">(</span><span class="na">orderId</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="na">item</span><span class="p">:</span> <span class="nx">DeleteItemInput</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">TableName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">orders</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">Key</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">orderId</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">S</span><span class="p">:</span> <span class="nx">orderId</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">await</span> <span class="nx">dynamoDb</span><span class="p">.</span><span class="nx">deleteItem</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span> <span class="c1">//delete the order</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>That's it run all the tests <code>npm t</code> and see them pass 😁</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Connecting the dots</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>We have been able test our repository against DynamoDB service running in LocalStack. What we want to do next is - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list {"ordered":true} --></p> <ol> <li>Deploy lambda function code against lambda function service in LocalStack</li> <li>Create Rest Api backed by lambda function in LocalStack</li> <li>Adding integration tests to send an http request against the Api Gateway</li> </ol> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>Let's start.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p><strong>Step 6: Deploy lambda function code</strong></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>In order to deploy the lambda function code, we need to build the code, archive it, upload the archive on S3 service running inside LocalStack and update CloudFormation template to create the lambda function by referring to the S3 bucket.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Let's archive the code, create an S3 bucket and upload the archive on S3 service.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"localstack:down"</span><span class="p">:</span><span class="w"> </span><span class="s2">"docker-compose -f test/docker-compose.yml down"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"localstack:up"</span><span class="p">:</span><span class="w"> </span><span class="s2">"docker-compose -f test/docker-compose.yml up -d"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"delay"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sleep 20"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"localstack:create-infra"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cd test/infra &amp;&amp; ./init.sh"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"archive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cd dist/ &amp;&amp; zip -r ../serverless-order-service.zip ."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pretest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"npm run build &amp;&amp; npm run archive &amp;&amp; npm run localstack:down &amp;&amp; npm run localstack:up &amp;&amp; npm run delay &amp;&amp; npm run localstack:create-infra"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jest test/**"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"build"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tsc"</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Following events happens as a part of pretest step –</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>Code gets built using <code>npm run build</code></li> <li>Distribution gets archived using <code>npm run archive</code></li> <li>LocalStack docker container gets stopped using <code>npm run localstack:down</code></li> <li>LocalStack docker container starts using <code>npm run localstack:down</code></li> <li>Some delay gets introduced using <code>npm run delay</code></li> <li>CloudFormation template gets deployed against LocalStack using <code>npm run localstack:create-infra</code></li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>package.json now runs <code>build</code> and <code>archive</code> as a part of <code>pretest</code> step. <code>archive</code> simply creates a zip file of the built code which is ready to be uploaded on an S3 bucket. localstack:create-infra now runs init.sh which delegates the job of creating a bucket, uploading the archive and deploying the infra to different scripts (we shall see it soon).</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Let's see the commands to create an S3 bucket and upload the archive. These are the same commands which will be executed from one of our shell scripts -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">&gt;</span> aws s3 mb s3://serverless-order-service <span class="nt">--endpoint-url</span> http://localhost:4572

<span class="o">&gt;</span> aws s3 <span class="nb">cp</span> ../../serverless-order-service.zip <span class="se">\</span>
s3://serverless-order-service <span class="nt">--endpoint-url</span> http://localhost:4572</code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Let's update CloudFormation template to create lambda resource.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">AWSTemplateFormatVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2010-09-09"</span>
<span class="na">Resources</span><span class="pi">:</span>
  <span class="na">OrdersFunction</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::Lambda::Function</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">FunctionName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">order-service-function"</span>
      <span class="na">Runtime</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nodejs10.x"</span>
      <span class="na">Handler</span><span class="pi">:</span> <span class="s2">"</span><span class="s">handler.ordersHandler"</span>
      <span class="na">Code</span><span class="pi">:</span>
        <span class="na">S3Bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">serverless-order-service"</span>   <span class="c1">## created earlier</span>
        <span class="na">S3Key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">serverless-order-service.zip"</span>  <span class="c1">## uploaded earlier</span>
        <span class="na">Role</span><span class="pi">:</span> <span class="kt">!GetAtt</span> <span class="s2">"</span><span class="s">OrdersRole.Arn"</span>         <span class="c1">## refer to a dummy role created below</span>

  <span class="na">OrdersRole</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::IAM::Role</span>                       <span class="c1">## dummy role</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">RoleName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">OrdersFunctionRole"</span>
      <span class="na">AssumeRolePolicyDocument</span><span class="pi">:</span>
        <span class="na">Version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2012-10-17"</span>
        <span class="na">Statement</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Allow"</span>
            <span class="na">Action</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s2">"</span><span class="s">sts:AssumeRole"</span>
            <span class="na">Principal</span><span class="pi">:</span>
              <span class="na">Service</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s2">"</span><span class="s">lambda.amazonaws.com"</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Executing <code>npm t</code> should now create AWS lambda function in LocalStack. We can verify the same -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">&gt;</span> aws lambda list-functions <span class="nt">--endpoint-url</span> http://localhost:4574/

//Output
<span class="o">{</span>
    <span class="s2">"FunctionArn"</span>: <span class="s2">"arn:aws:lambda:us-east-1:000000000000:function:order-service-function"</span>, 
    <span class="s2">"Handler"</span>: <span class="s2">"handler.ordersHandler"</span>, 
    <span class="s2">"Role"</span>: <span class="s2">"test_role"</span>, 
    <span class="s2">"Timeout"</span>: 3, 
    <span class="s2">"Runtime"</span>: <span class="s2">"nodejs10.x"</span>
<span class="o">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Let's move on to creating a Rest Api.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p><strong>Step 7: Create Rest Api </strong></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>This should be simple, let's update our CloudFormation template to have a Rest Api with <code>/orders/{instanceId}</code> as the resource and a <code>GET</code> method.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">AWSTemplateFormatVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2010-09-09"</span>
<span class="na">Resources</span><span class="pi">:</span>
  <span class="c1">## Content Trimmed</span>

  <span class="na">OrdersApiGateway</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::ApiGateway::RestApi</span> <span class="c1">## create a rest api</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">Name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orders-api"</span>

  <span class="na">OrdersResource</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::ApiGateway::Resource</span> <span class="c1">## create an "orders" resource</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">ParentId</span><span class="pi">:</span> <span class="kt">!GetAtt</span> <span class="s2">"</span><span class="s">OrdersApiGateway.RootResourceId"</span>
      <span class="na">PathPart</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orders"</span>
      <span class="na">RestApiId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s2">"</span><span class="s">OrdersApiGateway"</span>

  <span class="na">OrderIdResource</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::ApiGateway::Resource</span> <span class="c1">## create an "{orderId}" resource</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">ParentId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s2">"</span><span class="s">OrdersResource"</span>
      <span class="na">PathPart</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{orderId}"</span>
      <span class="na">RestApiId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s2">"</span><span class="s">OrdersApiGateway"</span>

  <span class="na">OrdersGetMethod</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::ApiGateway::Method</span> <span class="c1">## create a "GET" method and integrate with lambda function</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">HttpMethod</span><span class="pi">:</span> <span class="s2">"</span><span class="s">GET"</span>
      <span class="na">AuthorizationType</span><span class="pi">:</span> <span class="s2">"</span><span class="s">NONE"</span>
      <span class="na">RestApiId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s2">"</span><span class="s">OrdersApiGateway"</span>
      <span class="na">ResourceId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s2">"</span><span class="s">OrderIdResource"</span>
      <span class="na">Integration</span><span class="pi">:</span>
        <span class="na">IntegrationHttpMethod</span><span class="pi">:</span> <span class="s2">"</span><span class="s">POST"</span>
        <span class="na">Type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">AWS_PROXY"</span>
        <span class="na">Uri</span><span class="pi">:</span>
          <span class="s">Fn::Join:</span>
            <span class="s">- ""</span>
            <span class="s">- - "arn:"</span>
              <span class="s">- "aws"</span>
              <span class="s">- ":apigateway:"</span>
              <span class="s">- Ref</span><span class="pi">:</span> <span class="s">AWS::Region</span>
              <span class="s">- :lambda:path/2015-03-31/functions/</span>
              <span class="s">- Fn::GetAtt:</span>
                  <span class="s">- OrdersFunction</span>
                  <span class="s">- Arn</span>
                  <span class="s">- /invocations</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Executing <code>npm t</code> should now create Rest Api in LocalStack. We can verify the same -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">&gt;</span> aws apigateway get-rest-apis <span class="se">\</span>
<span class="nt">--query</span> <span class="s2">"items[?name=='orders-api'].id"</span> <span class="se">\</span>
<span class="nt">--output</span> text <span class="nt">--region</span> us-east-1 <span class="se">\</span>
<span class="nt">--endpoint-url</span><span class="o">=</span>http://localhost:4567

//Should print Api Id</code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p><strong>Step 8: Adding Integration Test for the application</strong></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>In order to write this integration test we should be sending an http request to an endpoint exposed by Api Gateway inside LocalStack. This endpoint with LocalStack looks like -<br /><em>http://localhost:4567/restapis/&lt;&lt;Rest Api Id&gt;&gt;/test/_user_request_/orders/&lt;&lt;Order Id&gt;&gt;</em></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>This means we need a way to get the rest api id that was created as a part of deployment of CloudFormation template. We will add <code>aws apigateway get-rest-apis</code> command as a part of a script which will be executed from <code>init.sh</code>. This command will write the rest api id into a file which will be read by our integration test.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#!/bin/sh</span>

aws apigateway get-rest-apis <span class="se">\</span>
<span class="nt">--query</span> <span class="s2">"items[?name=='orders-api'].id"</span> <span class="se">\</span>
<span class="nt">--output</span> text <span class="nt">--region</span> us-east-1 <span class="se">\</span>
<span class="nt">--endpoint-url</span><span class="o">=</span>http://localhost:4567 <span class="o">&gt;</span> rest_api_id</code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>This is how our init.sh looks now -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#!/bin/sh</span>

./createBucket.sh                       //creates a bucket
./package.sh                            //copies the archive
./deploy.sh                             //deploys the cloudformation
./outputRestApiId.sh                    //logs the rest api <span class="nb">id </span>to a file</code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Now, it is the time to add integration test.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">OrderRepositoryFixture</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./fixture/OrderRepositoryFixture</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Order</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/model/Order</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">fs</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">path</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">Axios</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">axios</span><span class="dl">"</span><span class="p">;</span> <span class="c1">//add axios as dev-dependency</span>

<span class="kd">let</span> <span class="nx">apiId</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>

<span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">//read rest api id</span>
    <span class="nx">apiId</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">"</span><span class="s2">test/infra/rest_api_id</span><span class="dl">"</span><span class="p">),</span> <span class="dl">"</span><span class="s2">utf8</span><span class="dl">"</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">should return an order given there is AN order for the provided order id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">orderId</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">order-500</span><span class="dl">"</span><span class="p">;</span>

    <span class="k">await</span> <span class="nx">OrderRepositoryFixture</span><span class="p">.</span><span class="nx">deleteAnOrder</span><span class="p">(</span><span class="nx">orderId</span><span class="p">);</span> <span class="c1">//delete an existing order</span>
    <span class="k">await</span> <span class="nx">OrderRepositoryFixture</span><span class="p">.</span><span class="nx">createAn</span><span class="p">(</span><span class="k">new</span> <span class="nx">Order</span><span class="p">(</span><span class="nx">orderId</span><span class="p">,</span> <span class="mi">4000</span><span class="p">));</span> <span class="c1">//save an new order</span>

    <span class="c1">//make an API call</span>
    <span class="kd">const</span> <span class="nx">apiUrl</span> <span class="o">=</span> <span class="s2">`http://localhost:4567/restapis/</span><span class="p">${</span><span class="nx">apiId</span><span class="p">}</span><span class="s2">/test/_user_request_/orders/</span><span class="p">${</span><span class="nx">orderId</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">apiUrl</span><span class="p">);</span>

    <span class="c1">//assert on the response status and the content</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span>
        <span class="dl">"</span><span class="s2">orderId</span><span class="dl">"</span><span class="p">:</span> <span class="nx">orderId</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">amount</span><span class="dl">"</span><span class="p">:</span> <span class="mi">4000</span>
    <span class="p">});</span>
<span class="p">},</span> <span class="mi">20000</span><span class="p">);</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Before the test can be run, we will have to make one change in <code>DynamoDbConfiguration</code>. It returns a <em>dynamoDbClient</em> which connects to dynamodb running on <code>localhost:4569</code>. This is not true anymore because lambda is running inside a docker container and for that lambda function "localhost:4569" will refer to the port 4569 on docker's IP. What we need is the port 4569 with the IP of host machine. So, let's make this change. This is how updated DynamoDbConfiguration will look like -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">DynamoDB</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">aws-sdk</span><span class="dl">"</span>

<span class="kd">const</span> <span class="nx">executionEnvironment</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">defaultExecutionEnvironment</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">local</span><span class="dl">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ExecutionEnvironment</span> <span class="o">||</span> <span class="nx">defaultExecutionEnvironment</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">isExecutionEnvironmentLocal</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">executionEnvironment</span><span class="p">()</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">local</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">dynamoDbClient</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isExecutionEnvironmentLocal</span><span class="p">())</span> <span class="p">{</span>
        <span class="cm">/** LOCALSTACK_HOSTNAME:
        *     for accessing the hostname from inside the container
        *   localhost: 
        *     for running repository integration tests which run on host machine
        **/</span>
        <span class="kd">const</span> <span class="nx">dynamoHost</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">LOCALSTACK_HOSTNAME</span> <span class="o">||</span> <span class="dl">"</span><span class="s2">localhost</span><span class="dl">"</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">DynamoDB</span><span class="p">({</span>
            <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-east-1</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">endpoint</span><span class="dl">"</span><span class="p">:</span><span class="s2">`http://</span><span class="p">${</span><span class="nx">dynamoHost</span><span class="p">}</span><span class="s2">:4569`</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">DynamoDB</span><span class="p">({</span>
            <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ap-south-1</span><span class="dl">"</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>LocalStack exposes an environment variable LOCALSTACK_HOSTNAME which is available inside docker process that refers to the host machine.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>That's it run all the tests <code>npm t</code> and see them pass 😁</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Summary</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>We used LocalStack to test our application. Everything is available <a href="https://github.com/aws-articles/serverless-order-service.git">here</a>.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Here is a quick glimpse of the sequence of events that happen when tests are executed.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:image {"id":1030,"sizeSlug":"large","className":"is-style-default"} --></p> <figure class="wp-block-image size-large is-style-default"><img src="/assets/img/pexels/serverless-localstack.png" alt="" class="wp-image-1030" /></figure> <p><!-- /wp:image --></p> <p><!-- wp:paragraph --></p> <p>Let's move on to our last <a href="/concluding-serverless-journey">article</a> and see everything in action on AWS account.</p> <p><!-- /wp:paragraph --></p> </section> <!-- Social media shares --> <div class="share-buttons"> <ul class="share-buttons"> <div class="meta">Share</div> <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ftech-lessons.in%2Ftesting-serverless-journey%2F" target="_blank" title=" Facebook"> <i class="fa fa-facebook-square fa-2x" aria-hidden="true"></i> <span class="sr-only">Share on Facebook</span> </a> </li> <li> <a href="https://twitter.com/intent/tweet?text=Testing+Serverless+Journey%20https%3A%2F%2Ftech-lessons.in%2Ftesting-serverless-journey%2F" target="_blank" title=""> <i class="fa fa-twitter-square fa-2x" aria-hidden="true"></i> <span class="sr-only">Tweet</span> </a> </li> <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https://tech-lessons.in/testing-serverless-journey/&title=Testing+Serverless+Journey%20%7C%20tech-lessons.in&summary=&source=https://tech-lessons.in/testing-serverless-journey/" target="_blank" title=" LinkedIn"> <i class="fa fa-linkedin fa-2x" aria-hidden="true"></i> <span class="sr-only">Share on LinkedIn</span> </a> </li> </ul> </div> <!-- Tag list --> <footer> <div class="tag-list"> <div class="meta">Tags</div> <a class="button" href="/tags#AWS+Lambda"> <p><i class="fa fa-tag fa-fw"></i> AWS Lambda</p> </a> <a class="button" href="/tags#Serverless"> <p><i class="fa fa-tag fa-fw"></i> Serverless</p> </a> </div> </footer> </article> <!-- Disqus --> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'techlessons'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view comments.</noscript> </div> <!-- Post navigation --> <div id="post-nav"> <div id="previous-post"> <a alt="Concluding Serverless Journey" href="/concluding-serverless-journey/"> <p>Previous post</p> Concluding Serverless Journey </a> </div> <div id="next-post"> <a alt="Beginning Serverless Journey" href="/beginning-serverless-journey/"> <p>Next post</p> Beginning Serverless Journey </a> </div> </div> <!-- To change color of links in the page --> <style> header#main { background-repeat:no-repeat; background-image: url('/assets/img/pexels/testing-serverless.png'); } </style> </div> <footer class="site-footer"> <p class="text"> tech-lessons.in © 2020. All Rights Reserved. Powered by <a href='https://jekyllrb.com/'>Jekyll</a> </p> <div class="footer-icons"> <ul> <li> <a href="https://github.com/sarthakmakhija" title="Follow on GitHub"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </li> <li> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" title="Follow on LinkedIn"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </li> </ul> <ul> </ul> </div> </footer> </body> </html>
