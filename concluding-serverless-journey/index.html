<!DOCTYPE html> <!-- Type on Strap jekyll theme v2.0.0 Copyright 2016-2019 Sylhare Theme free for personal and commercial use under the MIT license https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE --> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> <!-- CSS --> <link rel="stylesheet" href="/assets/css/main.css"> <!--Favicon--> <link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon"> <!-- Canonical --> <link rel="canonical" href="https://tech-lessons.in/concluding-serverless-journey/"> <!-- KaTeX 0.8.3 --> <!-- if you have any issue check https://github.com/KaTeX/KaTeX --> <!-- Google Analytics --> <!-- End Google Analytics --> <!-- seo tags --> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Concluding Serverless Journey | tech-lessons.in</title> <meta name="generator" content="Jekyll v3.8.5" /> <meta property="og:title" content="Concluding Serverless Journey" /> <meta name="author" content="Sarthak Makhija" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Let’s deploy our Serverless application. We will be using AWS CDK to deploy our application that includes infra and the code. What would be interesting is to see if we can make our infra testable." /> <meta property="og:description" content="Let’s deploy our Serverless application. We will be using AWS CDK to deploy our application that includes infra and the code. What would be interesting is to see if we can make our infra testable." /> <link rel="canonical" href="https://tech-lessons.in/concluding-serverless-journey/" /> <meta property="og:url" content="https://tech-lessons.in/concluding-serverless-journey/" /> <meta property="og:site_name" content="tech-lessons.in" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-03-18T00:00:00+05:30" /> <script type="application/ld+json"> {"description":"Let’s deploy our Serverless application. We will be using AWS CDK to deploy our application that includes infra and the code. What would be interesting is to see if we can make our infra testable.","author":{"@type":"Person","name":"Sarthak Makhija"},"@type":"BlogPosting","url":"https://tech-lessons.in/concluding-serverless-journey/","headline":"Concluding Serverless Journey","dateModified":"2020-03-18T00:00:00+05:30","datePublished":"2020-03-18T00:00:00+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://tech-lessons.in/concluding-serverless-journey/"},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <!-- Manual seo tags --> <!-- <title>Concluding Serverless Journey | tech-lessons.in</title> <meta name="description" content="Let's deploy our Serverless application. We will be using AWS CDK to deploy our application that includes infra and the code. What would be interesting is to..."> --> </head> <script defer=true src="/assets/js/main.min.js"></script> <body> <header class="site-header"> <!-- Toggle menu --> <nav class="clear"> <a aria-label="pull" id="pull" class="toggle" href="#"> <i class="fa fa-bars fa-lg"></i> </a> <!-- Brand Logo --> <a class="navbar-brand" href="/"> <img src="/assets/img/pexels/logo.png" alt="tech-lessons" title="tech-lessons"> </a> <!-- Menu --> <ul class="hide"> <li class="separator"> |</li> <li> <a class="clear" aria-label="Home" title="Home" href="/"> <i class="fa fa-fw fa-home" aria-hidden="true"></i> Home </a> </li> <li class="separator"> |</li> <li> <a class="clear" aria-label="About Me" title="About Me" href="/about/"> <i class="fa fa-fw fa-male" aria-hidden="true"></i> About Me </a> </li> <li class="separator"> |</li> <li> <a class="clear" aria-label="Search" title="Search" href="/search/"> <i class="fa fa-fw fa-search" aria-hidden="true"></i> Search </a> </li> <li class="separator"> |</li> <li> <a class="clear" aria-label="Tags" title="Tags" href="/tags/"> <i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags </a> </li> </ul> </nav> </header> <div class="content"> <meta property="og:url" content="/concluding-serverless-journey/" /> <meta property="og:type" content="article" /> <meta property="og:title" content="Concluding Serverless Journey" /> <meta property="og:description" content="Let&#39;s deploy our Serverless application. We will be using AWS CDK to deploy our application that includes infra and the code. What would be interesting is to see if we can make our infra testable." /> <meta property="og:image" content="assets/img/pexels/concluding-serverless.png" /> <article class="feature-image"> <header id="main" style=""></header> <section class="post-content"> <h1 id="Concluding+Serverless+Journey" class="title">Concluding Serverless Journey</h1> <p><!-- wp:paragraph --></p> <p>We have come a long way in our <a href="/beginning-serverless-journey">Serverless journey</a>. This journey which started with building a serverless application has finally come to a stage where we can see all our hard work in action. Yes, we will be deploying our application.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>We will be using <a href="https://docs.aws.amazon.com/cdk/latest/guide/home.html">AWS CDK</a> to deploy our application. Before we start using CDK, let's quickly look at what is CDK -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:group --></p> <div class="wp-block-group"> <div class="wp-block-group__inner-container"><!-- wp:quote {"align":"left"} --></p> <blockquote class="wp-block-quote has-text-align-left"><p>The AWS Cloud Development Kit (AWS CDK) is an open source software development framework to model and <strong>provision your cloud application resources using familiar programming languages.</strong></p> <p>Provisioning cloud applications can be a challenging process that requires you to perform manual actions, write custom scripts, maintain templates, or learn domain-specific languages. </p> <p>AWS CDK uses the familiarity and <strong>expressive power of programming languages for modeling your applications</strong>. It provides you with high-level components that preconfigure cloud resources with proven defaults, so you can build cloud applications without needing to be an expert. </p> <p><strong>AWS CDK provisions your resources in a safe, repeatable manner through AWS CloudFormation</strong>. It also enables you to <strong>compose and share your own custom components</strong> that incorporate your organization's requirements, helping you start new projects faster. <br/><a href="https://aws.amazon.com/cdk/">https://aws.amazon.com/cdk/</a></p> </blockquote> <p><!-- /wp:quote --></div> </div> <p><!-- /wp:group --></p> <p><!-- wp:paragraph --></p> <p>In summary, we don't have to directly deal with CloudFormation or SAM for deploying our application. We will provision our cloud resources using a higher level framework called CDK which will ultimately translate into a CloudFormation template. </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>We should be able to see the advantages of using CDK very soon but let's look at this conversation to get some understanding of CDK.</p> <p><!-- /wp:paragraph --></p> <p> <figure class="wp-block-embed-youtube wp-block-embed is-type-video is-provider-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"> <div class="wp-block-embed__wrapper"> <iframe width="800" height="400" src="https://www.youtube.com/embed/W8sibGJnHEM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe> </div> </figure> <p>Let's begin now.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Step 1: Setting up the project</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>We will be using the same project which was pushed <a href="https://github.com/aws-articles/serverless-order-service">here</a>. </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>Install CDK globally by executing <code>npm install aws-cdk -g</code></li> <li>Create a directory named <code>infra</code> inside our project serverless-order-service</li> <li>Execute <code>cdk init app --language=typescript</code> inside <code>infra</code> directory</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>This should generate a project which uses <code>typescript</code> as the programming language and <code>jest</code> as a testing framework. Let's update the generated <code>jest.config.js</code>.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Below is how our jest.config.js will look like -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">testMatch</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">**/__tests__/**/*.+(ts|tsx|js)</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">**/?(*.)+(spec|test).+(ts|tsx|js)</span><span class="dl">"</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">transform</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">^.+</span><span class="se">\\</span><span class="s2">.(ts|tsx)$</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ts-jest</span><span class="dl">"</span>
    <span class="p">},</span>
<span class="p">};</span></code></pre></figure> <p><!-- /wp:code --></p> <p> <div class="wp-block-image is-style-default"> <img style="padding-left: 0" src="/assets/img/pexels/project-setup-cdk.png" width="400" height="400" class="wp-image-878"/> </div> <p>If all has gone well so far this how our project structure will look like -</p> <ul> <li><em>infra-stack.ts</em> defines a class called <em>InfraStack</em> which is going to be a logical collection of various constructs like lambda function(s), dynamodb etc </li> <li><em>infra.ts</em> is the entry point of the application which creates an instance of InfraStack</li> <li><em>infra.test.ts</em> contains a simple test to assert an empty stack</li> <li><em>package.json</em> contains the project definition along with various dependencies including <em>@aws-cdk/assert</em> which is a library for asserting various cloud resources </li> <li><em>jest.config.js </em>contains the necessary configuration to run jest tests</li> <li><em>cdk.json </em>contains the command to run cdk application</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>Let's make a few quick changes to the file names to match our convention, run the test and commit the changes -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>Rename infra.ts to OrderServiceInfra.ts</li> <li>Rename infra-stack.ts to OrderServiceInfraStack.ts</li> <li>Rename infra.test.ts to OrderServiceInfraStack.spec.ts</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Step 2: Creating stack with lambda function</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>Let's provision our lambda function. In order to do so we need to add a dependency <code>@aws-cdk/aws-lambda</code>. So, let's add it by executing <code>npm install @aws-cdk/aws-lambda@1.19.0</code>.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>We will start by creating a lambda function construct inside OrderServiceInfraStack.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">cdk</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nb">Function</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-lambda</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrderServiceInfraStack</span> <span class="kd">extends</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">Stack</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">Construct</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">props</span><span class="p">?:</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">StackProps</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>

        <span class="c1">//create a lambda function in the stack</span>
        <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">"</span><span class="s2">order-service-function</span><span class="dl">"</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="c1">//compilation error</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Few quick observations - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>We have imported Function class from @aws-cdk/aws-lambda</li> <li>Constructor of Function class takes 3 parameters - <ul> <li>scope: Construct - which identifies the parent resource</li> <li>id: string - unique identifier of the resource within the stack</li> <li>props: FunctionProps - lambda function properties including name, runtime, handler etc</li> </ul> </li> <li>Typescript compiler gives an error because null is not acceptable in place of FunctionProps</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>Let's pass the required function properties - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">Code</span><span class="p">,</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">FunctionProps</span><span class="p">,</span> <span class="nx">Runtime</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-lambda</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Construct</span><span class="p">,</span> <span class="nx">Stack</span><span class="p">,</span> <span class="nx">StackProps</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrderServiceInfraStack</span> <span class="kd">extends</span> <span class="nx">Stack</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">props</span><span class="p">?:</span> <span class="nx">StackProps</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>

        <span class="c1">//create FunctionProps</span>
        <span class="kd">const</span> <span class="nx">functionProperties</span><span class="p">:</span> <span class="nx">FunctionProps</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">code</span><span class="p">:</span> <span class="nx">Code</span><span class="p">.</span><span class="nx">fromAsset</span><span class="p">(</span><span class="dl">"</span><span class="s2">../dist</span><span class="dl">"</span><span class="p">),</span>
            <span class="na">handler</span><span class="p">:</span> <span class="dl">"</span><span class="s2">handler.ordersHandler</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">runtime</span><span class="p">:</span> <span class="nx">Runtime</span><span class="p">.</span><span class="nx">NODEJS_10_X</span><span class="p">,</span>
            <span class="na">functionName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">order-service-function</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">environment</span><span class="p">:</span> <span class="p">{</span><span class="dl">"</span><span class="s2">ExecutionEnvironment</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span><span class="p">}</span>
        <span class="p">};</span>
        <span class="c1">//create a lambda function in the stack</span>
        <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">"</span><span class="s2">order-service-function</span><span class="dl">"</span><span class="p">,</span> <span class="nx">functionProperties</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Here, <em>code, handler and runtime</em> are the only mandatory properties. Passing them should make the compiler happy. </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>With this change in OrderServiceInfraStack, our test will break because it asserts for empty resources inside the stack but now stack contains a lambda function. We will fix the test in a moment.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Quick observation - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>We are passing <code>ExecutionEnvironment</code> as lambda environment variable. This variable is used to determine if the lambda is running is running in test mode or production mode. This value can also be taken as deployment parameter, but for now we are passing it as dev </li> <li>We have used <code>../dist </code>inside code asset which contains our transpiled code</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Step 3: Fixing the test</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>CDK allows us to write different forms of tests including snapshot tests and fine grained unit tests. We will be writing both the tests - snapshot test(s) for our entire stack and unit tests for resources like lambda function, dynamodb, api gateway etc.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>We will be starting with unit tests which will assert on a resource and its properties.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">OrderServiceInfraStack</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../lib/OrderServiceInfraStack</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">App</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Runtime</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-lambda</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">@aws-cdk/assert/jest</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">stack should contain a lambda function with node10 as the runtime</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OrderServiceInfraStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">"</span><span class="s2">OrderServiceStack</span><span class="dl">"</span><span class="p">);</span> <span class="c1">//instantiate stack</span>

    <span class="c1">//assert that stack contains a lambda function with node10 as the runtime</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">toHaveResource</span><span class="p">(</span><span class="dl">"</span><span class="s2">AWS::Lambda::Function</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">Runtime</span><span class="p">:</span> <span class="nx">Runtime</span><span class="p">.</span><span class="nx">NODEJS_10_X</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="p">})</span>
<span class="p">});</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Few quick observations - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>We have imported <code>aws-cdk/assert/jest</code> which provides us with <code>expect</code> function that allows us to match resources in the stack </li> <li>Our unit test asserts only on lambda's runtime property</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>That's it. Our lambda function resource is created in the stack and we have been able to write a unit test. Let's commit the changes.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Step 4: Adding DynamoDB to stack</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>Let's provision dynamodb. In order to do so we need to add a dependency <code>@aws-cdk/aws-dynamodb</code>. So, let's add it by executing <code>npm install @aws-cdk/aws-dynamodb@1.19.0</code>.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">Code</span><span class="p">,</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">FunctionProps</span><span class="p">,</span> <span class="nx">Runtime</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-lambda</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Construct</span><span class="p">,</span> <span class="nx">Stack</span><span class="p">,</span> <span class="nx">StackProps</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">AttributeType</span><span class="p">,</span> <span class="nx">Table</span><span class="p">,</span> <span class="nx">TableProps</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-dynamodb</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrderServiceInfraStack</span> <span class="kd">extends</span> <span class="nx">Stack</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">props</span><span class="p">?:</span> <span class="nx">StackProps</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>

        <span class="kd">const</span> <span class="nx">functionProperties</span><span class="p">:</span> <span class="nx">FunctionProps</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">code</span><span class="p">:</span> <span class="nx">Code</span><span class="p">.</span><span class="nx">fromAsset</span><span class="p">(</span><span class="dl">"</span><span class="s2">../dist</span><span class="dl">"</span><span class="p">),</span>
            <span class="na">handler</span><span class="p">:</span> <span class="dl">"</span><span class="s2">handler.ordersHandler</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">runtime</span><span class="p">:</span> <span class="nx">Runtime</span><span class="p">.</span><span class="nx">NODEJS_10_X</span><span class="p">,</span>
            <span class="na">functionName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">order-service-function</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">environment</span><span class="p">:</span> <span class="p">{</span><span class="dl">"</span><span class="s2">ExecutionEnvironment</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span><span class="p">}</span>
        <span class="p">};</span>
        <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">"</span><span class="s2">order-service-function</span><span class="dl">"</span><span class="p">,</span> <span class="nx">functionProperties</span><span class="p">);</span>

        <span class="c1">//create TableProps</span>
        <span class="kd">const</span> <span class="na">tableProps</span><span class="p">:</span> <span class="nx">TableProps</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">partitionKey</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">orderId</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">type</span><span class="p">:</span> <span class="nx">AttributeType</span><span class="p">.</span><span class="nx">STRING</span>
            <span class="p">},</span>
            <span class="na">tableName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">orders</span><span class="dl">"</span>
        <span class="p">};</span>
        <span class="c1">//create a dynamo table in the stack</span>
        <span class="k">new</span> <span class="nx">Table</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">"</span><span class="s2">order-table</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tableProps</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Few quick observations - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>We have imported Table class from @aws-cdk/aws-dynamodb</li> <li>Constructor of Table class takes 3 parameters - <ul> <li>scope: Construct - which identifies the parent resource</li> <li>id: string - unique identifier of the resource within the stack</li> <li>props: TableProps - table properties including name of the table, partitionKey etc</li> </ul> </li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>That's it. Our dynamo table resource is created in the stack. Let's verify by writing a unit test.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">stack should contain a dynamodb table with table name</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OrderServiceInfraStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">"</span><span class="s2">OrderServiceStack</span><span class="dl">"</span><span class="p">);</span>

    <span class="c1">//assert that stack contains a dynamo table with "orders" as the table name</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">toHaveResource</span><span class="p">(</span><span class="dl">"</span><span class="s2">AWS::DynamoDB::Table</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">TableName</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">orders</span><span class="dl">"</span>
    <span class="p">})</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">stack should contain a dynamodb table with orderId as the Hash key</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OrderServiceInfraStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">"</span><span class="s2">OrderServiceStack</span><span class="dl">"</span><span class="p">);</span>

    <span class="c1">//assert that stack contains a dynamo table with "orderId" as the HASH key</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">toHaveResource</span><span class="p">(</span><span class="dl">"</span><span class="s2">AWS::DynamoDB::Table</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">KeySchema</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="dl">"</span><span class="s2">AttributeName</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">orderId</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">KeyType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">HASH</span><span class="dl">"</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">})</span>
<span class="p">});</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Step 5: Refactoring the stack</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>Let's look at a unit test and see if there are any challenges in understanding it.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">stack should contain a lambda function with node10 as runtime</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OrderServiceInfraStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">"</span><span class="s2">OrderServiceStack</span><span class="dl">"</span><span class="p">);</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">toHaveResource</span><span class="p">(</span><span class="dl">"</span><span class="s2">AWS::Lambda::Function</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">Runtime</span><span class="p">:</span> <span class="nx">Runtime</span><span class="p">.</span><span class="nx">NODEJS_10_X</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="p">})</span>
<span class="p">});</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:list {"ordered":true} --></p> <ol> <li>How do you know our stack will contain a lambda function with node10 as the runtime? Honestly, there is no relation between the test input and its output </li> <li>Even though the test is for OrderServiceStack, I see that we are trying to assert on properties of a resource. It somehow looks to me like a misplaced test </li> </ol> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>In order to solve both the problems, we can create a component (or a class) which accepts configuration properties and creates a lambda function. This means we will be able to move lambda function unit tests closer to that class and make the unit tests more revealing. Let's see how. </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Let's consider that all our lambda functions are based on "node10" runtime. With this consideration, we can create a class, <code>Node10LambdaFunction</code> that represents a lambda function and accepts <code>Node10LambdaFunctionProperties</code>.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">Code</span><span class="p">,</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">FunctionProps</span><span class="p">,</span> <span class="nx">Runtime</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-lambda</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Construct</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">//inherit from Function</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Node10LambdaFunction</span> <span class="kd">extends</span> <span class="nb">Function</span> <span class="p">{</span>
    <span class="c1">//accepts Node10FunctionProperties which will contain attributes that make sense for our project</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">properties</span><span class="p">:</span> <span class="nx">Node10FunctionProperties</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">functionName</span><span class="p">,</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">toFunctionProps</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">Node10LambdaFunctionProperties</span> <span class="p">{</span>
    <span class="c1">//attributes that make sense at this stage</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">code</span><span class="p">:</span> <span class="nx">Code</span><span class="p">,</span>
                <span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span>
                <span class="nx">readonly</span> <span class="nx">functionName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span>
                <span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">environmentVariables</span><span class="p">?:</span> <span class="p">{[</span><span class="na">key</span><span class="p">:</span> <span class="nx">string</span><span class="p">]:</span> <span class="nx">string</span> <span class="p">})</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">//behavior to return AWS FunctionProps</span>
    <span class="nx">toFunctionProps</span><span class="p">():</span> <span class="nx">FunctionProps</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">code</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span>
            <span class="na">handler</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">handler</span><span class="p">,</span>
            <span class="na">runtime</span><span class="p">:</span> <span class="nx">Runtime</span><span class="p">.</span><span class="nx">NODEJS_10_X</span><span class="p">,</span>
            <span class="na">functionName</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">functionName</span><span class="p">,</span>
            <span class="na">environment</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">environmentVariables</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Few quick observations - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>Client of Node10LambdaFunction (which is going be our stack now) is not required to pass runtime as it is evident from the name itself </li> <li>Client code is not required to pass id of the resource. Node10LambdaFunction passes function name as the id of the resource </li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>Now, we can move the lambda function unit tests closer to <code>Node10LambdaFunction</code>. This is how the updated test(s) will look like -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">stack should contain a lambda function with node10 as runtime</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stack</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node10LambdaFunctionProperties</span><span class="p">(</span>
        <span class="nx">Code</span><span class="p">.</span><span class="nx">fromAsset</span><span class="p">(</span><span class="dl">"</span><span class="s2">../dist</span><span class="dl">"</span><span class="p">),</span>
        <span class="dl">"</span><span class="s2">handler.ordersHandler</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">order-service-function</span><span class="dl">"</span><span class="p">);</span>

    <span class="c1">//name of the class indicates a lambda function with node10 as the runtime will be created</span>
    <span class="k">new</span> <span class="nx">Node10LambdaFunction</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">properties</span><span class="p">);</span>

    <span class="c1">//assert that stack contains a lambda function with node10 as the runtime. This time the test is not magical</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">toHaveResource</span><span class="p">(</span><span class="dl">"</span><span class="s2">AWS::Lambda::Function</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">Runtime</span><span class="p">:</span> <span class="nx">Runtime</span><span class="p">.</span><span class="nx">NODEJS_10_X</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="p">})</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">stack should contain a lambda function with specified environment variable</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stack</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node10LambdaFunctionProperties</span><span class="p">(</span>
        <span class="nx">Code</span><span class="p">.</span><span class="nx">fromAsset</span><span class="p">(</span><span class="dl">"</span><span class="s2">../dist</span><span class="dl">"</span><span class="p">),</span>
        <span class="dl">"</span><span class="s2">handler.ordersHandler</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">order-service-function</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">{</span><span class="dl">"</span><span class="s2">env</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span><span class="p">});</span>

    <span class="k">new</span> <span class="nx">Node10LambdaFunction</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">properties</span><span class="p">);</span>

    <span class="c1">//assert that stack contains a lambda function with provided environment variable</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">toHaveResource</span><span class="p">(</span><span class="dl">"</span><span class="s2">AWS::Lambda::Function</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">Environment</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">Variables</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">env</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">});</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Here, we are not instantiating OrderServiceStack but creating an empty stack which gets passed to Node10LambdaFunction. </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Similarly, we can write other tests around lambda function like - assert that lambda function is created with a given name, assert that lambda function is inside a VPC etc. <i>I will make similar changes for Dynamo table and commit the code.</i></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>With these changes, we can write unit tests for various components (as fine grained as we want) and a snapshot test for the entire stack.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Step 6: Adding lambda backed public RestApi to stack</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>Let's provision a rest api. In order to do so we need to add a dependency <code>@aws-cdk/aws-apigateway</code>. So, let's add it by executing <code>npm install @aws-cdk/aws-apigateway@1.19.0</code>.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Following the same pattern we would like to create a class that allows us to add an endpoint which can be accessed publicly and is backed by a lambda function.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">LambdaRestApi</span><span class="p">,</span> <span class="nx">LambdaRestApiProps</span><span class="p">,</span> <span class="nx">MethodLoggingLevel</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-apigateway</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Construct</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Node10LambdaFunction</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../function/Node10LambdaFunction</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">IFunction</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-lambda</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">//inherit from LambdaRestApi</span>
<span class="kd">class</span> <span class="nx">LambdaBackedPublicRestApi</span> <span class="kd">extends</span> <span class="nx">LambdaRestApi</span> <span class="p">{</span>

    <span class="c1">//similar to Node10Function, it accepts LambdaBackedPublicRestApiProperties</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">properties</span><span class="p">:</span> <span class="nx">LambdaBackedPublicRestApiProperties</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">apiName</span><span class="p">,</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">toLambdaRestApiProps</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">LambdaBackedPublicRestApiProperties</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">(</span><span class="nx">readonly</span> <span class="nx">apiName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span>
                <span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">stageName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span>
                <span class="kr">private</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">Node10LambdaFunction</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">//behavior to return LambdaRestApiProps</span>
    <span class="nx">toLambdaRestApiProps</span><span class="p">():</span> <span class="nx">LambdaRestApiProps</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">restApiName</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">apiName</span><span class="p">,</span>
            <span class="na">deployOptions</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">stageName</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stageName</span><span class="p">,</span>
                <span class="na">loggingLevel</span><span class="p">:</span> <span class="nx">MethodLoggingLevel</span><span class="p">.</span><span class="nx">INFO</span>
            <span class="p">},</span>
            <span class="na">proxy</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="na">handler</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">handler</span> <span class="k">as</span> <span class="nx">IFunction</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>This will create a RestApi in the stack for us but there is no endpoint available for us. In order to allow that to happen we can expose a method that takes a resource path say - "<code>orders/{orderId}</code>" and an http method which needs to be attached to the last part of resource which in this example is <code>{orderId}</code>.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>So, let's do this.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span>
    <span class="nx">LambdaRestApi</span><span class="p">,</span>
    <span class="nx">LambdaRestApiProps</span><span class="p">,</span>
    <span class="nx">MethodLoggingLevel</span><span class="p">,</span>
    <span class="nx">Resource</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-apigateway</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Construct</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Node10LambdaFunction</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../function/Node10LambdaFunction</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">IFunction</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-lambda</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">class</span> <span class="nx">LambdaBackedPublicRestApi</span> <span class="kd">extends</span> <span class="nx">LambdaRestApi</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">properties</span><span class="p">:</span> <span class="nx">LambdaBackedPublicRestApiProperties</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">apiName</span><span class="p">,</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">toLambdaRestApiProps</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="c1">//add resource say, orders/{orderId} and a method GET against {orderId}</span>
    <span class="nx">addEndpoint</span><span class="p">(</span><span class="nx">resourcePath</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">httpMethod</span><span class="p">:</span> <span class="nx">HttpMethod</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">resourcePath</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">IllegalArgumentException</span><span class="p">(</span>
                <span class="s2">`</span><span class="p">${</span><span class="nx">resourcePath</span><span class="p">}</span><span class="s2"> should not begin with a / while adding a rest endpoint`</span>
            <span class="p">);</span>

        <span class="kd">const</span> <span class="nx">resource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAllResourcesUsing</span><span class="p">(</span><span class="nx">resourcePath</span><span class="p">);</span>
        <span class="nx">resource</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span><span class="nx">httpMethod</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//add resources recursively</span>
    <span class="kr">private</span> <span class="nx">addAllResourcesUsing</span><span class="p">(</span><span class="nx">resourcePath</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">Resource</span> <span class="p">{</span>
        <span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">resources</span><span class="p">:</span> <span class="nx">string</span><span class="p">[],</span> <span class="nx">rootResource</span><span class="p">:</span> <span class="nx">Resource</span><span class="p">):</span> <span class="nx">Resource</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">resources</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">rootResource</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="k">return</span> <span class="nx">add</span><span class="p">(</span>
                    <span class="nx">resources</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">resources</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span>
                    <span class="nx">LambdaBackedPublicRestApi</span><span class="p">.</span><span class="nx">getOrAdd</span><span class="p">(</span><span class="nx">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">rootResource</span><span class="p">)</span>
                <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">add</span><span class="p">(</span><span class="nx">resourcePath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">),</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">root</span> <span class="k">as</span> <span class="nx">Resource</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">//return the already added resource or add</span>
    <span class="kr">private</span> <span class="kd">static</span> <span class="nx">getOrAdd</span><span class="p">(</span><span class="nx">resourcePath</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">rootResource</span><span class="p">:</span> <span class="nx">Resource</span><span class="p">):</span> <span class="nx">Resource</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">alreadyPresentResource</span> <span class="o">=</span> <span class="nx">rootResource</span><span class="p">.</span><span class="nx">getResource</span><span class="p">(</span><span class="nx">resourcePath</span><span class="p">)</span> <span class="k">as</span> <span class="nx">Resource</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">alreadyPresentResource</span> <span class="o">||</span> <span class="nx">rootResource</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="nx">resourcePath</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">enum</span> <span class="nx">HttpMethod</span> <span class="p">{</span>
    <span class="nx">GET</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">IllegalArgumentException</span> <span class="kd">extends</span> <span class="nb">Error</span> <span class="p">{</span>
<span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Few quick observations - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>We do not expect the resource path to begin with a "/", <code>aws-apigateway</code> throws an error if that is the case </li> <li>We are recursively adding each resource from the resource path</li> <li>Http method gets added on the last resource of the resource path</li> <li><code>getOrAdd</code> ensures that we do not add the same resource again. Eg; if we want to add 2 resource paths <code>serverless/lambda</code> and <code>serverless/lambda/{functionId}</code>, it is necessary to ensure we do not add <code>serverless/lambda</code> again</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>Let's quickly add a couple of unit tests.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">LambdaBackedPublicRestApi</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../../lib/restapi/public/LambdaBackedPublicRestApi</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Stack</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">LambdaBackedPublicRestApiProperties</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../../lib/restapi/public/LambdaBackedPublicRestApiProperties</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Node10LambdaFunctionProperties</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../../lib/function/Node10LambdaFunctionProperties</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Code</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-lambda</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Node10LambdaFunction</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../../lib/function/Node10LambdaFunction</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">HttpMethod</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../../lib/restapi/public/HttpMethod</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">CfnMethod</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-apigateway</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">@aws-cdk/assert/jest</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">addFakeEndpoint</span> <span class="o">=</span> <span class="p">(</span><span class="nx">api</span><span class="p">:</span> <span class="nx">LambdaBackedPublicRestApi</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">addEndpoint</span><span class="p">(</span><span class="dl">"</span><span class="s2">fake</span><span class="dl">"</span><span class="p">,</span> <span class="nx">HttpMethod</span><span class="p">.</span><span class="nx">GET</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">stack should contain a public api with a name</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stack</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">node10LambdaFunction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node10LambdaFunction</span><span class="p">(</span>
        <span class="nx">stack</span><span class="p">,</span>
        <span class="k">new</span> <span class="nx">Node10LambdaFunctionProperties</span><span class="p">(</span>
            <span class="nx">Code</span><span class="p">.</span><span class="nx">fromAsset</span><span class="p">(</span><span class="dl">"</span><span class="s2">../dist</span><span class="dl">"</span><span class="p">),</span>
            <span class="dl">"</span><span class="s2">handler.ordersHandler</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">order-service-function</span><span class="dl">"</span><span class="p">));</span>

    <span class="kd">const</span> <span class="nx">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LambdaBackedPublicRestApiProperties</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">orders-api</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span><span class="p">,</span>
        <span class="nx">node10LambdaFunction</span>
    <span class="p">);</span>

    <span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LambdaBackedPublicRestApi</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">properties</span><span class="p">);</span>
    <span class="nx">addFakeEndpoint</span><span class="p">(</span><span class="nx">api</span><span class="p">);</span>

    <span class="c1">//assert that stack contains a rest api with "orders-api" as the name</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">toHaveResource</span><span class="p">(</span><span class="dl">"</span><span class="s2">AWS::ApiGateway::RestApi</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">Name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">orders-api</span><span class="dl">"</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">stack should contain a public api with an http method GET added to the resource</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stack</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">node10LambdaFunction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node10LambdaFunction</span><span class="p">(</span>
        <span class="nx">stack</span><span class="p">,</span>
        <span class="k">new</span> <span class="nx">Node10LambdaFunctionProperties</span><span class="p">(</span>
            <span class="nx">Code</span><span class="p">.</span><span class="nx">fromAsset</span><span class="p">(</span><span class="dl">"</span><span class="s2">../dist</span><span class="dl">"</span><span class="p">),</span>
            <span class="dl">"</span><span class="s2">handler.ordersHandler</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">order-service-function</span><span class="dl">"</span><span class="p">));</span>

    <span class="kd">const</span> <span class="nx">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LambdaBackedPublicRestApiProperties</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">orders-api</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span><span class="p">,</span>
        <span class="nx">node10LambdaFunction</span>
    <span class="p">);</span>

    <span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LambdaBackedPublicRestApi</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">properties</span><span class="p">);</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">addEndpoint</span><span class="p">(</span><span class="dl">"</span><span class="s2">article/serverless</span><span class="dl">"</span><span class="p">,</span> <span class="nx">HttpMethod</span><span class="p">.</span><span class="nx">GET</span><span class="p">);</span>

    <span class="c1">//get a resource and a CfnMethod against that resource</span>
    <span class="kd">const</span> <span class="nx">serverlessResource</span> <span class="o">=</span> <span class="nx">api</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">getResource</span><span class="p">(</span><span class="dl">"</span><span class="s2">article</span><span class="dl">"</span><span class="p">)?.</span><span class="nx">getResource</span><span class="p">(</span><span class="dl">"</span><span class="s2">serverless</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">serverlessResource</span><span class="p">?.</span><span class="nx">node</span><span class="p">.</span><span class="nx">findChild</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">)</span> <span class="k">as</span> <span class="nx">CfnMethod</span><span class="p">;</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">method</span><span class="p">.</span><span class="nx">httpMethod</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">HttpMethod</span><span class="p">.</span><span class="nx">GET</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p><em>These tests assert that a rest api exists with a given name and an http method is attached to a resource.</em></p> <p><!-- /wp:paragraph --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Step 7: Updating the stack</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>Let's update the stack to have lambda function, dynamo table, lambda backed public api and dynamo table read access to lambda function.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">Code</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-lambda</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Construct</span><span class="p">,</span> <span class="nx">Stack</span><span class="p">,</span> <span class="nx">StackProps</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">AttributeType</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/aws-dynamodb</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Node10LambdaFunction</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./function/Node10LambdaFunction</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Node10LambdaFunctionProperties</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./function/Node10LambdaFunctionProperties</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DynamoTable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./dynamodb/DynamoTable</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DynamoTableProperties</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./dynamodb/DynamoTableProperties</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">PrimaryKey</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./dynamodb/PrimaryKey</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">PartitionKey</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./dynamodb/PartitionKey</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">LambdaBackedPublicRestApi</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./restapi/public/LambdaBackedPublicRestApi</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">LambdaBackedPublicRestApiProperties</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./restapi/public/LambdaBackedPublicRestApiProperties</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">HttpMethod</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./restapi/public/HttpMethod</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrderServiceInfraStack</span> <span class="kd">extends</span> <span class="nx">Stack</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">props</span><span class="p">?:</span> <span class="nx">StackProps</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>

        <span class="c1">//use the newly prepared classes</span>
        <span class="kd">const</span> <span class="nx">ordersFunction</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ordersFunction</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">ordersTable</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ordersTable</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">restApi</span>        <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lambdaBackedPublicRestApi</span><span class="p">(</span><span class="nx">ordersFunction</span><span class="p">);</span>

        <span class="nx">restApi</span><span class="p">.</span><span class="nx">addEndpoint</span><span class="p">(</span><span class="dl">"</span><span class="s2">orders/{orderId}</span><span class="dl">"</span><span class="p">,</span> <span class="nx">HttpMethod</span><span class="p">.</span><span class="nx">GET</span><span class="p">);</span> <span class="c1">//add the required resources along with HTTP method</span>
        <span class="nx">ordersTable</span><span class="p">.</span><span class="nx">grantReadData</span><span class="p">(</span><span class="nx">ordersFunction</span><span class="p">);</span> <span class="c1">//grant read access on "orders" table to lambda function</span>
    <span class="p">}</span>

    <span class="c1">//returns an instance of Node10LambdaFunction</span>
    <span class="kr">private</span> <span class="nx">ordersFunction</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Node10LambdaFunction</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Node10LambdaFunctionProperties</span><span class="p">(</span>
            <span class="nx">Code</span><span class="p">.</span><span class="nx">fromAsset</span><span class="p">(</span><span class="dl">"</span><span class="s2">../dist</span><span class="dl">"</span><span class="p">),</span>
            <span class="dl">"</span><span class="s2">handler.ordersHandler</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">order-service-function</span><span class="dl">"</span><span class="p">,</span>
            <span class="p">{</span><span class="dl">"</span><span class="s2">ExecutionEnvironment</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span><span class="p">})</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//returns an instance of DynamoTable</span>
    <span class="kr">private</span> <span class="nx">ordersTable</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">DynamoTable</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">new</span> <span class="nx">DynamoTableProperties</span><span class="p">(</span>
            <span class="dl">"</span><span class="s2">orders</span><span class="dl">"</span><span class="p">,</span>
            <span class="k">new</span> <span class="nx">PrimaryKey</span><span class="p">(</span>
                <span class="k">new</span> <span class="nx">PartitionKey</span><span class="p">(</span>
                    <span class="dl">"</span><span class="s2">orderId</span><span class="dl">"</span><span class="p">,</span>
                    <span class="nx">AttributeType</span><span class="p">.</span><span class="nx">STRING</span><span class="p">)</span>
            <span class="p">))</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//returns an instance of LambdaBackedPublicRestApi</span>
    <span class="kr">private</span> <span class="nx">lambdaBackedPublicRestApi</span><span class="p">(</span><span class="nx">lambda</span><span class="p">:</span> <span class="nx">Node10LambdaFunction</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">LambdaBackedPublicRestApi</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">new</span> <span class="nx">LambdaBackedPublicRestApiProperties</span><span class="p">(</span>
            <span class="dl">"</span><span class="s2">orders-api</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">dev</span><span class="dl">"</span><span class="p">,</span>
            <span class="nx">lambda</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>Time to add our snapshot test, probably simpler than you might have thought of -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">OrderServiceInfraStack</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../lib/OrderServiceInfraStack</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">App</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">@aws-cdk/assert/jest</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">should create order service stack</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OrderServiceInfraStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">"</span><span class="s2">OrderServiceStack</span><span class="dl">"</span><span class="p">);</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">stack</span><span class="p">).</span><span class="nx">toMatchSnapshot</span><span class="p">();</span>
<span class="p">});</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Step 8: Deploying our stack</h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>We have worked hard to create all the resources that are needed in our stack. Now is the time to deploy our stack and see things in action.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Let's update <code>OrderServiceInfra</code> to pass stack name as a part of stack properties. It is this file which acts as an entry point for the application and is referred in cdk.json.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span class="cp">#!/usr/bin/env node
</span><span class="k">import</span> <span class="dl">"</span><span class="s2">source-map-support/register</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">OrderServiceInfraStack</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../lib/OrderServiceInfraStack</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">StackProps</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">cdk</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">@aws-cdk/core</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">App</span><span class="p">();</span>
<span class="c1">//pass stack name</span>
<span class="kd">const</span> <span class="nx">stackProps</span><span class="p">:</span><span class="nx">StackProps</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">stackName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">order-service-stack</span><span class="dl">"</span>
<span class="p">};</span>
<span class="c1">//instantiate OrderServiceInfraStack</span>
<span class="k">new</span> <span class="nx">OrderServiceInfraStack</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">"</span><span class="s2">OrderServiceStack</span><span class="dl">"</span><span class="p">,</span> <span class="nx">stackProps</span><span class="p">);</span></code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>CDK also provides us with various commands - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li><code>cdk list</code> - lists the stacks</li> <li><code>cdk deploy</code> - deploys the stack in AWS environment</li> <li><code>cdk destroy</code> - destroys the stacks</li> <li><code>cdk synthesize</code> - synthesizes and prints the CloudFormation</li> <li><code>cdk bootstrap</code> - deploys the CDK toolkit stack into an AWS environment</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>We need to execute <code>cdk bootrap</code> and <code>cdk deploy</code> from <code>infra</code> directory to deploy stack in our AWS account.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:code --></p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">&gt;</span> <span class="nb">cd </span>infra
<span class="o">&gt;</span> cdk bootstrap
<span class="o">&gt;</span> cdk deploy</code></pre></figure> <p><!-- /wp:code --></p> <p><!-- wp:paragraph --></p> <p>These commands make a few assumptions -</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>AWS credentials are already configured on host machine</li> <li>AWS user has the right to create various AWS resources including IAM roles</li> <li><code>dist/</code> directory which will be deployed on an S3 bucket (bootstrap creates for us) when we execute <code>cdk bootstrap</code>, already exists </li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>It will take sometime for stack to be created which will consist of <code>lambda function, dynamo table, api gateway and all the necessary IAM roles</code>.</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>Once our stack is created, make an entry in <code>orders</code> table, hit the public api endpoint which will look like <em><code>https://rest-api-id.execute-api.ap-south-1.amazonaws.com/dev/orders/OrderId</code></em> and enjoy the output. </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:paragraph --></p> <p>That's it, our stack is deployed and our application is up and running 😁</p> <p><!-- /wp:paragraph --></p> <p><!-- wp:heading {"level":4} --></p> <h4>Conclusion </h4> <p><!-- /wp:heading --></p> <p><!-- wp:paragraph --></p> <p>Relationship between CDK and CloudFormation can be summarised as -</p> <p><!-- /wp:paragraph --></p> <p> <div class="wp-block-image is-style-default"> <figure class="aligncenter size-large is-resized"><img src="/assets/img/pexels/cdk.png" class="wp-image-1043"/></figure> </div> <p><!-- /wp:image --></p> <p><!-- wp:paragraph --></p> <p>In this article we were able to code our infra using CDK, write tests for our infra and deploy the same. Let's take a look at some of the advantages of using <a href="https://docs.aws.amazon.com/cdk/latest/guide/home.html">CDK</a> - </p> <p><!-- /wp:paragraph --></p> <p><!-- wp:list --></p> <ul> <li>Resources can be modeled in Object Oriented manner</li> <li>High level abstractions can be defined and published within the team or company</li> <li>Infrastructure can be built as library</li> <li>Infrastructure code can be tested</li> <li>IDE's code completion can be leveraged</li> <li>Programming language constructs like if statements, for-loops, etc can be used when defining infrastructure</li> </ul> <p><!-- /wp:list --></p> <p><!-- wp:paragraph --></p> <p>We have finally come to end of our Serverless Journey series. Hope you enjoyed it.</p> <p><!-- /wp:paragraph --></p> </section> <!-- Social media shares --> <div class="share-buttons"> <ul class="share-buttons"> <div class="meta">Share</div> <li> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ftech-lessons.in%2Fconcluding-serverless-journey%2F" target="_blank" title=" Facebook"> <i class="fa fa-facebook-square fa-2x" aria-hidden="true"></i> <span class="sr-only">Share on Facebook</span> </a> </li> <li> <a href="https://twitter.com/intent/tweet?text=Concluding+Serverless+Journey%20https%3A%2F%2Ftech-lessons.in%2Fconcluding-serverless-journey%2F" target="_blank" title=""> <i class="fa fa-twitter-square fa-2x" aria-hidden="true"></i> <span class="sr-only">Tweet</span> </a> </li> <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=https://tech-lessons.in/concluding-serverless-journey/&title=Concluding+Serverless+Journey%20%7C%20tech-lessons.in&summary=&source=https://tech-lessons.in/concluding-serverless-journey/" target="_blank" title=" LinkedIn"> <i class="fa fa-linkedin fa-2x" aria-hidden="true"></i> <span class="sr-only">Share on LinkedIn</span> </a> </li> </ul> </div> <!-- Tag list --> <footer> <div class="tag-list"> <div class="meta">Tags</div> <a class="button" href="/tags#AWS+Lambda"> <p><i class="fa fa-tag fa-fw"></i> AWS Lambda</p> </a> <a class="button" href="/tags#Serverless"> <p><i class="fa fa-tag fa-fw"></i> Serverless</p> </a> </div> </footer> </article> <!-- Disqus --> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'techlessons'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view comments.</noscript> </div> <!-- Post navigation --> <div id="post-nav"> <div id="next-post"> <a alt="Testing Serverless Journey" href="/testing-serverless-journey/"> <p>Next post</p> Testing Serverless Journey </a> </div> </div> <!-- To change color of links in the page --> <style> header#main { background-repeat:no-repeat; background-image: url('/assets/img/pexels/concluding-serverless.png'); } </style> </div> <footer class="site-footer"> <p class="text"> tech-lessons.in © 2020. All Rights Reserved. Powered by <a href='https://jekyllrb.com/'>Jekyll</a> </p> <div class="footer-icons"> <ul> <li> <a href="https://github.com/sarthakmakhija" title="Follow on GitHub"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </li> <li> <a href="https://www.linkedin.com/in/sarthak-makhija-7a165a55/" title="Follow on LinkedIn"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </li> </ul> <ul> </ul> </div> </footer> </body> </html>
